import React, { useState, useEffect } from 'react';
import { useLocation } from 'react-router-dom';
import { useForm, useFieldArray, Controller } from 'react-hook-form';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import axios from 'axios';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { WelfareType, ParticipantGroup, ParticipantMember } from '@/types';
import { useAuth } from '@/context/AuthContext';
import { useWelfare } from '@/context/WelfareContext';
import { useInternalTraining } from '@/context/InternalTrainingContext';
import { ArrowLeft, Check, Loader2, AlertCircle, Plus, X, Paperclip, Download } from 'lucide-react';
import { useToast } from '@/components/ui/use-toast';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { supabase } from '@/integrations/supabase/client';

import LoadingPopup from './LoadingPopup';
import { generateWelfarePDF } from '../pdf/WelfarePDFGenerator';
import { generateTrainingPDF } from '../pdf/TrainingPDFGenerator';
import { generateAdvancePDF } from '../pdf/AdvancePDFGenerator';
import { uploadPDFToSupabase } from '@/utils/pdfUtils';
import { DigitalSignature } from '../signature/DigitalSignature';
import { ParticipantSelector } from './ParticipantSelector';

interface WelfareFormProps {
  type: WelfareType;
  onBack: () => void;
  editId?: number | null;
}

// 1. เธญเธฑเธเน€เธ”เธ• FormValues Interface
interface FormValues {
  startDate: string;
  endDate: string;
  totalDays: number;
  amount: number;
  details: string;
  title?: string;

  birthType?: 'natural' | 'caesarean';
  funeralType?: 'employee_spouse' | 'child' | 'parent';
  attachments?: FileList;
  trainingTopics?: { value: string }[];
  totalAmount?: number;
  tax7Percent?: number;
  withholdingTax3Percent?: number;
  netAmount?: number;
  excessAmount?: number;
  companyPayment?: number;
  employeePayment?: number;
  courseName?: string;
  organizer?: string;
  isVatIncluded?: boolean; // เน€เธเธดเนเธก field เธชเธณเธซเธฃเธฑเธ checkbox

  // Internal Training fields
  department?: string;
  branch?: string;
  startTime?: string;
  endTime?: string;
  totalHours?: number;
  venue?: string;
  participants?: ParticipantGroup[];
  totalParticipants?: number;
  instructorFee?: number;
  instructorFeeWithholding?: number;
  instructorFeeVat?: number;
  instructorFeeTotal?: number;
  roomFoodBeverage?: number;
  roomFoodBeverageWithholding?: number;
  roomFoodBeverageVat?: number;
  roomFoodBeverageTotal?: number;
  otherExpenses?: number;
  otherExpensesWithholding?: number;
  otherExpensesVat?: number;
  otherExpensesTotal?: number;
  withholdingTax?: number;
  vat?: number;
  averageCostPerPerson?: number;
  taxCertificateName?: string;
  withholdingTaxAmount?: number;
  additionalNotes?: string;

  // Advance (เน€เธเธดเธเน€เธเธดเธเธ—เธ”เธฅเธญเธ) fields
  advanceDepartment?: string; // เนเธเธเธ
  advanceDistrict?: string; // เน€เธเธ•
  advanceActivityType?: string; // เธเธฃเธฐเน€เธ เธ—เธเธดเธเธเธฃเธฃเธก
  advanceActivityOther?: string; // เธฃเธฐเธเธธเธญเธทเนเธเน
  advanceShopCompany?: string; // เธเธทเนเธญเธฃเนเธฒเธ/เธเธฃเธดเธฉเธฑเธ—
  advanceAmphur?: string; // เธญเธณเน€เธ เธญ
  advanceProvince?: string; // เธเธฑเธเธซเธงเธฑเธ”
  advanceEventDate?: string; // เธงเธฑเธเธ—เธตเนเธเธฑเธ”
  advanceParticipants?: number; // เธเธณเธเธงเธเธเธนเนเน€เธเนเธฒเธฃเนเธงเธก
  advanceDailyRate?: number;
  advanceAccommodationCost?: number;
  advanceTransportationCost?: number;
  advanceMealAllowance?: number;
  advanceOtherExpenses?: number;
  advanceProjectName?: string;
  advanceProjectLocation?: string;

  // Attachment selections for welfare PDF (exclude training/internal/advance)
  attachmentSelections?: {
    receipt?: boolean;
    birthCertificate?: boolean;
    medicalCertificate?: boolean;
    idCardCopy?: boolean;
    deathCertificate?: boolean;
    marriageCertificate?: boolean;
    bankBookCopy?: boolean;
    weddingCard?: boolean;
    other?: boolean;
    otherText?: string;
  };
}

// Available teams/departments for internal training
const TEAMS = [
  'Management',
  'Account',
  'Inspiration (IS)',
  'Marketing(PES)',
  'Marketing(DIS)',
  'Marketing(COP)',
  'Marketing(PD)',
  'Procurement',
  'Strategy',
];

// Employee levels for internal training (เธ•เธฒเธก PDF)
const EMPLOYEE_LEVELS = [
  'เธเธเธฑเธเธเธฒเธ',
  'เน€เธเนเธฒเธซเธเนเธฒเธ—เธตเน',
  'เธเธนเนเธเนเธงเธขเธซเธฑเธงเธซเธเนเธฒเธเธฒเธ',
  'เธซเธฑเธงเธซเธเนเธฒเธเธฒเธ',
  'เธเธนเนเธเนเธงเธขเธเธนเนเธเธฑเธ”เธเธฒเธฃ',
  'เธเธนเนเธเธฑเธ”เธเธฒเธฃ',
  'เธฃเธญเธเธเธฃเธฃเธกเธเธฒเธฃเธเธนเนเธเธฑเธ”เธเธฒเธฃ',
  'เธเธฃเธฃเธกเธเธฒเธฃเธเธนเนเธเธฑเธ”เธเธฒเธฃ / เธเธฃเธฐเธเธฒเธ'
];

const DEPARTMENTS = [
  'เธ—เธฃเธฑเธเธขเธฒเธเธฃเธเธธเธเธเธฅ',
];

const BRANCHES = [
  'เธชเธณเธเธฑเธเธเธฒเธเธชเธธเธฃเธงเธเธจเน',
  'เนเธฃเธเธเธฒเธเธเธเธฃเธเธเธก',
];

// เธเธฃเธฐเน€เธ เธ—เธเธดเธเธเธฃเธฃเธกเธชเธณเธซเธฃเธฑเธเน€เธเธดเธเน€เธเธดเธเธ—เธ”เธฅเธญเธ
const ACTIVITY_TYPES = [
  'เธเธฑเธ”เธเธฃเธฐเธเธธเธก',
  'เธญเธญเธเธเธนเธ',
  'เธ”เธตเน€เธฅเธญเธฃเน',
  'เธเธฑเธเธ”เธตเธฅเน€เธฅเธญเธฃเน',
  'เธญเธทเนเธเน เธฃเธฐเธเธธ'
];

// Helper to get form title by welfare type
const getFormTitle = (type: WelfareType): string => {
  const titles: Record<WelfareType, string> = {
    wedding: 'เนเธเธเธเธญเธฃเนเธกเธเธญเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเนเธฒเนเธ•เนเธเธเธฒเธ',
    training: 'เนเธเธเธเธญเธฃเนเธกเธเธญเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเนเธฒเธญเธเธฃเธก',
    childbirth: 'เนเธเธเธเธญเธฃเนเธกเธเธญเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเนเธฒเธเธฅเธญเธ”เธเธธเธ•เธฃ',
    funeral: 'เนเธเธเธเธญเธฃเนเธกเธเธญเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเนเธฒเธเนเธงเธขเน€เธซเธฅเธทเธญเธเธฒเธเธจเธ',
    glasses: 'เนเธเธเธเธญเธฃเนเธกเธเธญเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเนเธฒเธ•เธฑเธ”เนเธงเนเธ',
    dental: 'เนเธเธเธเธญเธฃเนเธกเธเธญเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเนเธฒเธ—เธณเธเธฑเธ',
    fitness: 'เนเธเธเธเธญเธฃเนเธกเธเธญเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเนเธฒเธญเธญเธเธเธณเธฅเธฑเธเธเธฒเธข',
    medical: 'เนเธเธเธเธญเธฃเนเธกเธเธญเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเนเธฒเธเธญเธเน€เธขเธตเนเธขเธกเธเธฃเธ“เธตเน€เธเนเธเธเนเธงเธข',
    internal_training: 'เธเธญเธฃเนเธกเน€เธเธดเธเธเนเธฒเธญเธเธฃเธก (เธ เธฒเธขเนเธ)',
    advance: 'เนเธเธเธเธญเธญเธเธธเธกเธฑเธ•เธดเน€เธเธดเธเน€เธเธดเธเธ—เธ”เธฅเธญเธ',
  };

  return titles[type] || 'เนเธเธเธเธญเธฃเนเธกเธเธญเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃ';
};

export function WelfareForm({ type, onBack, editId }: WelfareFormProps) {
  // เธฃเธญเธเธฃเธฑเธ editId เธเธฒเธ prop (modal edit) เธซเธฃเธทเธญเธเธฒเธ query string (เธซเธเนเธฒ /Forms)
  const location = useLocation();
  let editIdNum: number | undefined = undefined;
  if (typeof editId === 'number') {
    editIdNum = editId;
  } else {
    const searchParams = new URLSearchParams(location.search);
    const editIdStr = searchParams.get('editId');
    editIdNum = editIdStr ? Number(editIdStr) : undefined;
  }
  const { user, profile } = useAuth();
  const { submitRequest, isLoading, getWelfareLimit, getRemainingBudget, trainingBudget, refreshRequests } = useWelfare();
  const { submitRequest: submitInternalTrainingRequest, refreshRequests: refreshInternalTrainingRequests } = useInternalTraining();
  const [files, setFiles] = useState<string[]>([]);
  const { toast } = useToast();
  const [maxAmount, setMaxAmount] = useState<number | null>(null);
  const [condition, setCondition] = useState<string | undefined>();
  const [isMonthly, setIsMonthly] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [employeeBudget, setEmployeeBudget] = useState<number | null>(null);
  const [showSignatureModal, setShowSignatureModal] = useState(false);
  const [userSignature, setUserSignature] = useState<string>('');
  const [pendingFormData, setPendingFormData] = useState<any>(null);
  const [employeeData, setEmployeeData] = useState<any>(null);
  const [workDaysError, setWorkDaysError] = useState<string>('');

  const {
    register,
    handleSubmit,
    reset,
    watch,
    setValue,
    control,
    formState: { errors }
  } = useForm<FormValues>({
    defaultValues: {
      trainingTopics: [{ value: '' }, { value: '' }],
      participants: [{ team: '', count: 0, selectedParticipants: [] }],
      attachmentSelections: {
        receipt: false,
        birthCertificate: false,
        medicalCertificate: false,
        idCardCopy: false,
        deathCertificate: false,
        marriageCertificate: false,
        bankBookCopy: false,
        weddingCard: false,
        other: false,
        otherText: ''
      }
    }
  });




  const { fields, append, remove } = useFieldArray({
    control,
    name: "trainingTopics"
  });

  const { fields: participantFields, append: appendParticipant, remove: removeParticipant } = useFieldArray({
    control,
    name: "participants"
  });

  // Fetch employee data when component mounts
  useEffect(() => {
    const fetchEmployeeData = async () => {
      if (!user?.email) return;

      try {
        const { data, error } = await supabase
          .from('Employee')
          .select('id, Name, Position, Team, start_date')
          .eq('email_user', user.email)
          .single();

        if (!error && data) {
          setEmployeeData(data);
        }
      } catch (error) {
        console.error('Error fetching employee data:', error);
      }
    };

    fetchEmployeeData();
  }, [user?.email]);

  // Helper function to calculate work days
  const calculateWorkDays = (startDate: string): number => {
    if (!startDate) return 0;
    const start = new Date(startDate);
    const today = new Date();
    const diffTime = today.getTime() - start.getTime();
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
  };

  // Check work days eligibility for training
  const checkTrainingEligibility = (employeeData: any): boolean => {
    if (type !== 'training' || !employeeData?.start_date) return true;

    const workDays = calculateWorkDays(employeeData.start_date);
    if (workDays < 180) {
      setWorkDaysError(`เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เน€เธเธดเธเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธญเธเธฃเธกเนเธ”เน เน€เธเธทเนเธญเธเธเธฒเธเธญเธฒเธขเธธเธเธฒเธเธขเธฑเธเนเธกเนเธ–เธถเธ 180 เธงเธฑเธ (เธเธฑเธเธเธธเธเธฑเธเธ—เธณเธเธฒเธเธกเธฒเนเธฅเนเธง ${workDays} เธงเธฑเธ)`);
      return false;
    }

    setWorkDaysError('');
    return true;
  };

  // 1. เธ•เธฑเนเธเธเนเธฒเธเธตเธ”เธเธณเธเธฑเธ”เนเธฅเธฐเน€เธเธทเนเธญเธเนเธเธเธญเธเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธ•เธฒเธก type เธ—เธธเธเธเธฃเธฑเนเธเธ—เธตเน type เธซเธฃเธทเธญ user เน€เธเธฅเธตเนเธขเธ
  useEffect(() => {
    if (!user) return;
    let limitAmount = 0;
    let limitCondition = '';
    let limitMonthly = false;
    if (type === 'training') {
      limitAmount = trainingBudget || 0;
      limitCondition = 'เธญเนเธฒเธเธญเธดเธเธเธฒเธเธเธเธเธฃเธฐเธกเธฒเธ“เธเธเน€เธซเธฅเธทเธญเธเธญเธเธเธเธฑเธเธเธฒเธ';
    } else {
      const limit = getWelfareLimit(type);
      limitAmount = limit.amount;
      limitCondition = limit.condition;
      limitMonthly = limit.monthly || false;
    }
    setMaxAmount(limitAmount);
    setIsMonthly(limitMonthly);
    setCondition(limitCondition);
    if (type === 'training' && user && profile) {
      const budgetResult = getRemainingBudget(user.id, type);
      setEmployeeBudget(budgetResult);
    } else if (type !== 'training' && limitAmount) {
      setValue('amount', parseFloat(limitAmount.toFixed(2)));
    }

    // เธ–เนเธฒเธกเธต editId เนเธซเนเธ”เธถเธเธเนเธญเธกเธนเธฅเธกเธฒ prefill
    const fetchEditData = async () => {
      if (editIdNum) {
        const { data, error } = await supabase
          .from('welfare_requests')
          .select('*')
          .eq('id', editIdNum)
          .single();
        if (!error && data) {
          // Map only fields that exist in the schema
          const dbData = data as any; // Type assertion for database fields
          reset({
            amount: dbData.amount,
            details: dbData.details || '',
            title: dbData.title || '',
            startDate: dbData.start_date || '',
            endDate: dbData.end_date || '',
            totalDays: dbData.total_days || 0,
            birthType: dbData.birth_type || '',
            funeralType: (dbData.funeral_type as 'employee_spouse' | 'child' | 'parent') || undefined,
            trainingTopics: dbData.training_topics ? JSON.parse(dbData.training_topics) : [],
            totalAmount: dbData.total_amount || 0,
            tax7Percent: dbData.tax7_percent || 0,
            withholdingTax3Percent: dbData.withholding_tax3_percent || 0,
            netAmount: dbData.net_amount || dbData.amount || 0,
            excessAmount: dbData.excess_amount || 0,
            companyPayment: dbData.company_payment || 0,
            employeePayment: dbData.employee_payment || 0,
            courseName: dbData.course_name || '',
            organizer: dbData.organizer || '',
            isVatIncluded: dbData.is_vat_included || false,
            // Internal Training detailed tax fields
            instructorFee: dbData.instructor_fee || 0,
            instructorFeeWithholding: dbData.instructor_fee_withholding || 0,
            instructorFeeVat: dbData.instructor_fee_vat || 0,
            instructorFeeTotal: dbData.instructor_fee_total || 0,
            roomFoodBeverage: dbData.room_food_beverage || 0,
            roomFoodBeverageWithholding: dbData.room_food_beverage_withholding || 0,
            roomFoodBeverageVat: dbData.room_food_beverage_vat || 0,
            roomFoodBeverageTotal: dbData.room_food_beverage_total || 0,
            otherExpenses: dbData.other_expenses || 0,
            otherExpensesWithholding: dbData.other_expenses_withholding || 0,
            otherExpensesVat: dbData.other_expenses_vat || 0,
            otherExpensesTotal: dbData.other_expenses_total || 0,
            withholdingTax: dbData.withholding_tax || 0,
            vat: dbData.vat || 0,
            // Advance fields
            advanceDepartment: dbData.advance_department || '',
            advanceDistrict: dbData.advance_district || '',
            advanceActivityType: dbData.advance_activity_type || '',
            advanceActivityOther: dbData.advance_activity_other || '',
            advanceShopCompany: dbData.advance_shop_company || '',
            advanceAmphur: dbData.advance_amphur || '',
            advanceProvince: dbData.advance_province || '',
            advanceEventDate: dbData.advance_event_date || '',
            advanceParticipants: dbData.advance_participants || 0,
            advanceDailyRate: dbData.advance_daily_rate || 0,
            advanceAccommodationCost: dbData.advance_accommodation_cost || 0,
            advanceTransportationCost: dbData.advance_transportation_cost || 0,
            advanceMealAllowance: dbData.advance_meal_allowance || 0,
            advanceOtherExpenses: dbData.advance_other_expenses || 0,
            advanceProjectName: dbData.advance_project_name || '',
            advanceProjectLocation: dbData.advance_project_location || '',
            // Attachment selections (if stored in future). Safe fallback.
            attachmentSelections: dbData.attachment_selections
              ? (typeof dbData.attachment_selections === 'string'
                  ? JSON.parse(dbData.attachment_selections)
                  : dbData.attachment_selections)
              : {
                  receipt: false,
                  birthCertificate: false,
                  medicalCertificate: false,
                  idCardCopy: false,
                  deathCertificate: false,
                  marriageCertificate: false,
                  bankBookCopy: false,
                  weddingCard: false,
                  other: false,
                  otherText: ''
                },
          });
          // Attachments
          if (data.attachment_url) {
            let attachments: string[] = [];
            if (Array.isArray(data.attachment_url)) {
              attachments = data.attachment_url;
            } else if (typeof data.attachment_url === 'string') {
              try {
                const parsed = JSON.parse(data.attachment_url);
                attachments = Array.isArray(parsed) ? parsed : [parsed];
              } catch {
                attachments = data.attachment_url ? [data.attachment_url] : [];
              }
            }
            setFiles(attachments);
          }
        }
      }
    };
    fetchEditData();
  }, [type, user, getWelfareLimit, setValue, trainingBudget, editId, reset]);

  // Check training eligibility when employeeData changes
  useEffect(() => {
    if (employeeData) {
      checkTrainingEligibility(employeeData);
    }
  }, [employeeData, type]);

  // For childbirth form
  const birthType = watch('birthType');

  // Update amount when birth type changes
  useEffect(() => {
    if (type === 'childbirth' && birthType) {
      const amount = birthType === 'natural' ? 4000.00 : 6000.00;
      setValue('amount', parseFloat(amount.toFixed(2)));
    }
  }, [birthType, type, setValue]);

  // เธเธณเธเธงเธ“เธเธฅเธฅเธฑเธเธเนเนเธซเธกเนเธ—เธฑเธเธ—เธตเน€เธกเธทเนเธญเน€เธเธฅเธตเนเธขเธ amount, VAT เธซเธฃเธทเธญ withholding tax
  // (เธขเนเธฒเธขเธกเธฒเธซเธฅเธฑเธเธเธฒเธเธเธฃเธฐเธเธฒเธจ currentRemainingBudget เน€เธเธทเนเธญเน€เธฅเธตเนเธขเธ TDZ)

  // Calculate total days when start or end date changes
  useEffect(() => {
    const startDate = watch('startDate');
    const endDate = watch('endDate');
    if (startDate && endDate) {
      const totalDays = calculateTotalDays(startDate, endDate);
      setValue('totalDays', totalDays);
    }
  }, [watch('startDate'), watch('endDate'), setValue]);

  // Calculate total participants for internal training
  useEffect(() => {
    if (type === 'internal_training') {
      const participants = watch('participants') || [];
      const total = participants.reduce((sum, p) => sum + (Number(p.count) || 0), 0);
      setValue('totalParticipants', total);
    }
  }, [watch('participants'), setValue, type]);

  // Watch for changes in participant counts and update total immediately
  const watchedParticipants = watch('participants');
  useEffect(() => {
    if (type === 'internal_training' && watchedParticipants) {
      // Calculate total based on actual selected participants, fallback to count
      const total = watchedParticipants.reduce((sum, p) => {
        const selectedCount = p?.selectedParticipants?.length || 0;
        const declaredCount = Number(p?.count) || 0;
        // Use the actual selected count, but don't exceed declared count
        return sum + Math.min(selectedCount, declaredCount);
      }, 0);
      setValue('totalParticipants', total);
    }
  }, [watchedParticipants, setValue, type]);

  // Calculate total hours for internal training
  useEffect(() => {
    if (type === 'internal_training') {
      const startTime = watch('startTime');
      const endTime = watch('endTime');
      const startDate = watch('startDate');
      const endDate = watch('endDate');

      if (startTime && endTime && startDate && endDate) {
        const start = new Date(`${startDate}T${startTime}`);
        const end = new Date(`${endDate}T${endTime}`);

        if (end > start) {
          const diffMs = end.getTime() - start.getTime();
          const diffHours = diffMs / (1000 * 60 * 60);
          setValue('totalHours', Math.round(diffHours * 100) / 100);
        }
      }
    }
  }, [watch('startTime'), watch('endTime'), watch('startDate'), watch('endDate'), setValue, type]);

  // Calculate advance total amount
  useEffect(() => {
    if (type === 'advance') {
      // Calculate total amount
      const dailyRate = Number(watch('advanceDailyRate')) || 0;
      const accommodationCost = Number(watch('advanceAccommodationCost')) || 0;
      const transportationCost = Number(watch('advanceTransportationCost')) || 0;
      const mealAllowance = Number(watch('advanceMealAllowance')) || 0;
      const otherExpenses = Number(watch('advanceOtherExpenses')) || 0;
      const participants = Number(watch('advanceParticipants')) || 0;

      const totalAmount = (dailyRate * participants) + accommodationCost + transportationCost + mealAllowance + otherExpenses;
      setValue('amount', Math.round(totalAmount * 100) / 100);
    }
  }, [watch('advanceDailyRate'), watch('advanceAccommodationCost'), watch('advanceTransportationCost'), watch('advanceMealAllowance'), watch('advanceOtherExpenses'), watch('advanceParticipants'), setValue, type]);

  // Calculate internal training costs with separate tax calculations
  useEffect(() => {
    if (type === 'internal_training') {
      const instructorFee = Number(watch('instructorFee')) || 0;
      const roomFoodBeverage = Number(watch('roomFoodBeverage')) || 0;
      const otherExpenses = Number(watch('otherExpenses')) || 0;
      const totalParticipants = Number(watch('totalParticipants')) || 0;

      // Get manual withholding tax and VAT values
      const instructorWithholding = Number(watch('instructorFeeWithholding')) || 0;
      const roomWithholding = Number(watch('roomFoodBeverageWithholding')) || 0;
      const otherWithholding = Number(watch('otherExpensesWithholding')) || 0;

      const instructorVat = Number(watch('instructorFeeVat')) || 0;
      const roomVat = Number(watch('roomFoodBeverageVat')) || 0;
      const otherVat = Number(watch('otherExpensesVat')) || 0;

      // Calculate totals for each category
      const instructorTotal = instructorFee + instructorVat - instructorWithholding;
      const roomTotal = roomFoodBeverage + roomVat - roomWithholding;
      const otherTotal = otherExpenses + otherVat - otherWithholding;

      // Calculate grand totals
      const totalWithholding = instructorWithholding + roomWithholding + otherWithholding;
      const totalVat = instructorVat + roomVat + otherVat;
      const grandTotal = instructorTotal + roomTotal + otherTotal;
      const average = totalParticipants > 0 ? grandTotal / totalParticipants : 0;

      // Set individual total values
      setValue('instructorFeeTotal', Math.round(instructorTotal * 100) / 100);
      setValue('roomFoodBeverageTotal', Math.round(roomTotal * 100) / 100);
      setValue('otherExpensesTotal', Math.round(otherTotal * 100) / 100);

      // Set summary values
      setValue('withholdingTax', Math.round(totalWithholding * 100) / 100);
      setValue('vat', Math.round(totalVat * 100) / 100);
      setValue('totalAmount', Math.round(grandTotal * 100) / 100);
      setValue('amount', Math.round(grandTotal * 100) / 100);
      setValue('averageCostPerPerson', Math.round(average * 100) / 100);
      setValue('withholdingTaxAmount', Math.round(totalWithholding * 100) / 100);
    }
  }, [watch('instructorFee'), watch('roomFoodBeverage'), watch('otherExpenses'), watch('totalParticipants'), watch('instructorFeeWithholding'), watch('roomFoodBeverageWithholding'), watch('otherExpensesWithholding'), watch('instructorFeeVat'), watch('roomFoodBeverageVat'), watch('otherExpensesVat'), setValue, type]);

  // Function to generate and download CSV for internal training
  const downloadTrainingCSV = () => {
    if (type !== 'internal_training') return;

    const formData = watch();
    const participants = formData.participants || [];

    // Collect all selected participants
    const allParticipants: any[] = [];
    let participantNumber = 1;

    participants.forEach((group: any) => {
      if (group.selectedParticipants && group.selectedParticipants.length > 0) {
        group.selectedParticipants.forEach((participant: any) => {
          allParticipants.push({
            no: participantNumber++,
            name: participant.name || '',
            team: group.team || '',
            position: participant.position || '',
            signatureIn: '',
            signatureOut: ''
          });
        });
      }
    });

    // Format date and venue info
    const startDate = formData.startDate ? new Date(formData.startDate).toLocaleDateString('th-TH', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }) : '';

    const endDate = formData.endDate ? new Date(formData.endDate).toLocaleDateString('th-TH', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }) : '';

    const startTime = formData.startTime || '';
    const endTime = formData.endTime || '';
    const venue = formData.venue || '';

    // Create date and venue string
    let dateVenueInfo = '';
    if (startDate && endDate && startDate === endDate) {
      dateVenueInfo = `${startDate} เน€เธงเธฅเธฒ ${startTime} - ${endTime} เธ. เธ“ ${venue}`;
    } else if (startDate && endDate) {
      dateVenueInfo = `${startDate} เธ–เธถเธ ${endDate} เน€เธงเธฅเธฒ ${startTime} - ${endTime} เธ. เธ“ ${venue}`;
    } else if (startDate) {
      dateVenueInfo = `${startDate} เน€เธงเธฅเธฒ ${startTime} - ${endTime} เธ. เธ“ ${venue}`;
    }

    // Create CSV content
    const csvContent = [
      // Header with course info
      ['เนเธเธเธฅเธเธ—เธฐเน€เธเธตเธขเธเธเธนเนเน€เธเนเธฒเธญเธเธฃเธก'],
      [''],
      [formData.courseName || 'MBTI Training 2025'],
      [''],
      [dateVenueInfo],
      [''],
      ['เธงเธดเธ—เธขเธฒเธเธฃ', '', '', '', ''],
      [''],
      // Table headers
      ['No.', 'Name', 'Team', 'Position', 'Signature', ''],
      ['', '', '', '', 'เธฃเธญเธเน€เธเนเธฒ', 'เธฃเธญเธเธเนเธฒเธข'],
      // Participant data
      ...allParticipants.map(p => [
        p.no,
        p.name,
        p.team,
        p.position,
        p.signatureIn,
        p.signatureOut
      ])
    ];

    // Convert to CSV string
    const csvString = csvContent
      .map(row => row.map(cell => `"${cell}"`).join(','))
      .join('\n');

    // Add BOM for proper UTF-8 encoding in Excel
    const BOM = '\uFEFF';
    const csvWithBOM = BOM + csvString;

    // Create and download file
    const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', `${formData.courseName || 'internal_training'}_participants.csv`);
    link.style.visibility = 'hidden';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    toast({
      title: 'เธ”เธฒเธงเธเนเนเธซเธฅเธ”เธชเธณเน€เธฃเนเธ',
      description: 'เนเธเธฅเน CSV เธฃเธฒเธขเธเธทเนเธญเธเธนเนเน€เธเนเธฒเธญเธเธฃเธกเธ–เธนเธเธ”เธฒเธงเธเนเนเธซเธฅเธ”เน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง',
    });
  };

  // เธเธฑเธเธเนเธเธฑเธเธชเธณเธซเธฃเธฑเธเธญเธฑเธเนเธซเธฅเธ”เนเธเธฅเนเนเธเธขเธฑเธ Supabase Storage
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const fileInput = e.target;

    if (!fileInput.files || fileInput.files.length === 0) return;

    try {
      const uploadPromises = Array.from(fileInput.files).map(async (file) => {
        // Create a unique file path
        const fileExt = file.name.split('.').pop();
        const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
        const filePath = `${user?.id || 'anonymous'}/${fileName}`;

        // Upload file to Supabase Storage
        const { data, error } = await supabase.storage
          .from('welfare-attachments')
          .upload(filePath, file);

        if (error) throw error;

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('welfare-attachments')
          .getPublicUrl(data.path);

        return publicUrl;
      });

      // Wait for all uploads to complete
      const uploadedUrls = await Promise.all(uploadPromises);

      // Update files state with new URLs
      setFiles(prevFiles => [...prevFiles, ...uploadedUrls]);

      toast({
        title: "เธญเธฑเธเนเธซเธฅเธ”เธชเธณเน€เธฃเนเธ",
        description: `เธญเธฑเธเนเธซเธฅเธ”เนเธเธฅเนเน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง`,
      });
    } catch (error: any) {
      console.error('Error uploading files:', error);
      toast({
        title: "เน€เธเธดเธ”เธเนเธญเธเธดเธ”เธเธฅเธฒเธ”",
        description: `เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เธญเธฑเธเนเธซเธฅเธ”เนเธเธฅเนเนเธ”เน: ${error.message}`,
        variant: "destructive",
      });
    } finally {
      // Reset the file input
      fileInput.value = '';
    }
  };

  // เธเธฑเธเธเนเธเธฑเธเธชเธณเธซเธฃเธฑเธเธฅเธเนเธเธฅเนเธ—เธตเนเธญเธฑเธเนเธซเธฅเธ”
  const handleRemoveFile = async (index: number) => {
    try {
      // Get the file URL to remove
      const fileUrl = files[index];

      // Extract the file path from the URL
      const filePath = fileUrl.split('/').slice(-2).join('/');

      // Delete the file from Supabase Storage
      const { error } = await supabase.storage
        .from('welfare-attachments')
        .remove([filePath]);

      if (error) throw error;

      // Update the files state
      setFiles(prevFiles => prevFiles.filter((_, i) => i !== index));

      toast({
        title: "เธฅเธเนเธเธฅเนเธชเธณเน€เธฃเนเธ",
        description: "เธฅเธเนเธเธฅเนเน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง",
      });
    } catch (error: any) {
      console.error('Error removing file:', error);
      toast({
        title: "เน€เธเธดเธ”เธเนเธญเธเธดเธ”เธเธฅเธฒเธ”",
        description: `เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เธฅเธเนเธเธฅเนเนเธ”เน: ${error.message}`,
        variant: "destructive",
      });
    }
  };

  // Get remaining budget from getBenefitLimits API to ensure consistency
  const [currentRemainingBudget, setCurrentRemainingBudget] = useState<number>(0);

  // Fetch remaining budget from getBenefitLimits API
  useEffect(() => {
    const fetchRemainingBudget = async () => {
      if (!user) return;

      try {
        const { getBenefitLimits } = await import('@/services/welfareApi');
        const limits = await getBenefitLimits();

        // เธชเธณเธซเธฃเธฑเธ glasses เนเธฅเธฐ dental เนเธเน budget_dentalglasses เธฃเนเธงเธกเธเธฑเธ
        if (type === 'glasses' || type === 'dental') {
          const dentalLimit = limits.find(limit => limit.type === 'dental');
          setCurrentRemainingBudget(dentalLimit ? dentalLimit.remaining : (profile?.budget_dentalglasses ?? 0));
        } else {
          const limit = limits.find(limit => limit.type === type);
          setCurrentRemainingBudget(limit ? limit.remaining : 0);
        }
      } catch (error) {
        console.error('Error fetching remaining budget:', error);
        // Fallback to context method
        if (type === 'glasses' || type === 'dental') {
          setCurrentRemainingBudget(profile?.budget_dentalglasses ?? 0);
        } else if (user?.id) {
          setCurrentRemainingBudget(getRemainingBudget(user.id, type));
        }
      }
    };

    fetchRemainingBudget();
  }, [user, type, profile?.budget_dentalglasses, getRemainingBudget]);

  const remainingBudget = currentRemainingBudget;
  // Recalculate when amount/VAT/withholding changes (after currentRemainingBudget is defined)
  useEffect(() => {
    const amount = watch('amount');
    const vatAmount = Number(watch('tax7Percent')) || 0;
    const withholdingAmount = Number(watch('withholdingTax3Percent')) || 0;

    if (type === 'training') {
      // Use actual remaining budget to compute overage
      if (amount !== undefined && amount !== null && !isNaN(Number(amount))) {
        calculateTrainingAmounts(Number(amount), Number(currentRemainingBudget || 0), vatAmount, withholdingAmount);
      }
    } else if (type === 'wedding' || type === 'childbirth' || type === 'funeral' || type === 'glasses' || type === 'dental' || type === 'fitness' || type === 'medical') {
      // Non-training calculation
      if (amount !== undefined && amount !== null && !isNaN(Number(amount))) {
        calculateNonTrainingAmounts(Number(amount), vatAmount, withholdingAmount);
      }
    }
  }, [watch('amount'), watch('tax7Percent'), watch('withholdingTax3Percent'), currentRemainingBudget, type]);

  const onSubmit = async (data: any) => {
    // Store form data and show signature modal for all types (including training)
    // Make sure we have employeeData before showing signature modal
    if (!employeeData) {
      toast({
        title: 'เน€เธเธดเธ”เธเนเธญเธเธดเธ”เธเธฅเธฒเธ”',
        description: 'เนเธกเนเธเธเธเนเธญเธกเธนเธฅเธเธเธฑเธเธเธฒเธ เธเธฃเธธเธ“เธฒเธฅเธญเธเนเธซเธกเนเธญเธตเธเธเธฃเธฑเนเธ',
        variant: 'destructive',
      });
      return;
    }

    // Check training eligibility before submission
    if (type === 'training' && !checkTrainingEligibility(employeeData)) {
      toast({
        title: 'เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เธชเนเธเธเธณเธฃเนเธญเธเนเธ”เน',
        description: workDaysError,
        variant: 'destructive',
      });
      return;
    }

    setPendingFormData({ data, employeeData });
    setShowSignatureModal(true);
  };

  const handleFormSubmit = async (data: any) => {
    try {
      setIsSubmitting(true);
      if (!user) {
        throw new Error('User not authenticated');
      }

      // First, fetch the employee data to get the correct department and name
      const { data: employeeData, error: employeeError } = await supabase
        .from('Employee')
        .select('id, Name, Position, Team, start_date')
        .eq('email_user', user.email)
        .single();

      console.log('employeeData:', employeeData);
      if (employeeError || !employeeData) {
        throw new Error('Employee data not found. Please contact support.');
      }

      // For training type, submit directly without PDF generation
      if (type === 'training') {
        await processFormSubmission(data, employeeData);
        return;
      }

      // Store form data and employee data for later use
      setPendingFormData({ data, employeeData });

      // Show signature modal for wedding type
      if (type === 'wedding') {
        setShowSignatureModal(true);
        setIsSubmitting(false);
        return;
      }

      if (editIdNum) {
        // เธ•เธฃเธงเธเธชเธญเธเธชเธ–เธฒเธเธฐเธเธณเธฃเนเธญเธเธเนเธญเธเธญเธเธธเธเธฒเธ•เนเธซเนเนเธเนเนเธ
        const { data: currentRequest, error: fetchError } = await supabase
          .from('welfare_requests')
          .select('status')
          .eq('id', editIdNum)
          .single();
        if (fetchError || !currentRequest) {
          throw new Error('เนเธกเนเธเธเธเนเธญเธกเธนเธฅเธเธณเธฃเนเธญเธ เธซเธฃเธทเธญเน€เธเธดเธ”เธเนเธญเธเธดเธ”เธเธฅเธฒเธ”เนเธเธเธฒเธฃเธ•เธฃเธงเธเธชเธญเธเธชเธ–เธฒเธเธฐ');
        }
        if (currentRequest.status && currentRequest.status.toLowerCase() === 'approved') {
          toast({
            title: 'เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เนเธเนเนเธเนเธ”เน',
            description: 'เธเธณเธฃเนเธญเธเธเธตเนเนเธ”เนเธฃเธฑเธเธเธฒเธฃเธญเธเธธเธกเธฑเธ•เธดเนเธฅเนเธง เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เนเธเนเนเธเนเธ”เน',
            variant: 'destructive',
          });
          setIsSubmitting(false);
          return;
        }
        // UPDATE EXISTING REQUEST
        const updateData: any = {
          amount: Number(data.netAmount || data.amount || 0), // Net amount เธขเธฑเธเธเธ map เนเธ column เน€เธ”เธดเธก
          details: data.details || '',
          title: data.title || '',
          attachment_url: JSON.stringify(files),
          updated_at: new Date().toISOString(),
          start_date: data.startDate,
          end_date: data.endDate,
          total_days: data.totalDays,
          birth_type: data.birthType,
          funeral_type: data.funeralType,
          training_topics: data.trainingTopics ? JSON.stringify(data.trainingTopics) : null,
          total_amount: data.totalAmount,
          tax7_percent: data.tax7Percent,
          withholding_tax3_percent: data.withholdingTax3Percent,
          net_amount: data.netAmount,
          excess_amount: data.excessAmount,
          company_payment: data.companyPayment,
          employee_payment: data.employeePayment,
          course_name: data.courseName,
          organizer: data.organizer,
          is_vat_included: data.isVatIncluded,
          department_request: (employeeData as any)?.Team,
          // Internal Training detailed tax fields
          instructor_fee: data.instructorFee,
          instructor_fee_withholding: data.instructorFeeWithholding,
          instructor_fee_vat: data.instructorFeeVat,
          instructor_fee_total: data.instructorFeeTotal,
          room_food_beverage: data.roomFoodBeverage,
          room_food_beverage_withholding: data.roomFoodBeverageWithholding,
          room_food_beverage_vat: data.roomFoodBeverageVat,
          room_food_beverage_total: data.roomFoodBeverageTotal,
          other_expenses: data.otherExpenses,
          other_expenses_withholding: data.otherExpensesWithholding,
          other_expenses_vat: data.otherExpensesVat,
          other_expenses_total: data.otherExpensesTotal,
          withholding_tax: data.withholdingTax,
          vat: data.vat,
          // Advance fields
          advance_department: data.advanceDepartment,
          advance_district: data.advanceDistrict,
          advance_activity_type: data.advanceActivityType,
          advance_activity_other: data.advanceActivityOther,
          advance_shop_company: data.advanceShopCompany,
          advance_amphur: data.advanceAmphur,
          advance_province: data.advanceProvince,
          advance_event_date: data.advanceEventDate,
          advance_participants: data.advanceParticipants,
          advance_daily_rate: data.advanceDailyRate,
          advance_accommodation_cost: data.advanceAccommodationCost,
          advance_transportation_cost: data.advanceTransportationCost,
          advance_meal_allowance: data.advanceMealAllowance,
          advance_other_expenses: data.advanceOtherExpenses,
          advance_project_name: data.advanceProjectName,
          advance_project_location: data.advanceProjectLocation,
          // Optionally persist attachment selections if a column exists in DB in future
          attachment_selections: data.attachmentSelections
            ? JSON.stringify(data.attachmentSelections)
            : null,
        };

        console.log('UPDATE MODE: updateData', updateData, 'editIdNum', editIdNum);

        const { error: updateError } = await supabase
          .from('welfare_requests')
          .update(updateData)
          .eq('id', editIdNum);

        if (updateError) {
          console.error('Supabase updateError:', updateError);
          throw new Error('เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เนเธเนเนเธเธเธณเธฃเนเธญเธเนเธ”เน เธเธฃเธธเธ“เธฒเธฅเธญเธเนเธซเธกเน');
        }

        await refreshRequests();

        toast({
          title: 'เนเธเนเนเธเธเธณเธฃเนเธญเธเธชเธณเน€เธฃเนเธ',
          description: 'เธเนเธญเธกเธนเธฅเธเธณเธฃเนเธญเธเนเธ”เนเธฃเธฑเธเธเธฒเธฃเนเธเนเนเธเน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง',
        });
        setTimeout(onBack, 2000);
        return;
      }

      // For wedding and advance types, show signature modal before submitting
      if (['wedding', 'advance'].includes(type)) {
        // Store form data temporarily
        setPendingFormData({ data, employeeData });
        setShowSignatureModal(true);
        setIsSubmitting(false);
        return;
      }

      // For non-wedding types, proceed with normal submission
      await processFormSubmission(data, employeeData);

    } catch (error: any) {
      console.error('Error submitting form:', error);
      toast({
        title: 'เน€เธเธดเธ”เธเนเธญเธเธดเธ”เธเธฅเธฒเธ”',
        description: error.message || 'เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เธชเนเธเธเธณเธฃเนเธญเธเนเธ”เน เธเธฃเธธเธ“เธฒเธฅเธญเธเนเธซเธกเนเธญเธตเธเธเธฃเธฑเนเธ',
        variant: 'destructive',
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  // Handle signature confirmation
  const handleSignatureConfirm = async (signatureData: string) => {
    setUserSignature(signatureData);

    if (pendingFormData) {
      try {
        setIsSubmitting(true);
        await processFormSubmission(pendingFormData.data, pendingFormData.employeeData, signatureData);
      } catch (error: any) {
        console.error('Error submitting form after signature:', error);
        toast({
          title: 'เน€เธเธดเธ”เธเนเธญเธเธดเธ”เธเธฅเธฒเธ”',
          description: error.message || 'เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เธชเนเธเธเธณเธฃเนเธญเธเนเธ”เน เธเธฃเธธเธ“เธฒเธฅเธญเธเนเธซเธกเนเธญเธตเธเธเธฃเธฑเนเธ',
          variant: 'destructive',
        });
      } finally {
        setIsSubmitting(false);
        setPendingFormData(null);
      }
    }
  };



  // Process form submission with PDF (for all types including training)
  const processFormSubmission = async (data: any, employeeData: any, signature?: string) => {
    // If employeeData is not provided, fetch it
    let finalEmployeeData = employeeData;
    if (!finalEmployeeData) {
      try {
        const { data: fetchedEmployeeData, error } = await supabase
          .from('Employee')
          .select('id, Name, Position, Team, start_date')
          .eq('email_user', user!.email)
          .single();

        if (!error && fetchedEmployeeData) {
          finalEmployeeData = fetchedEmployeeData;
        } else {
          throw new Error('เนเธกเนเธเธเธเนเธญเธกเธนเธฅเธเธเธฑเธเธเธฒเธ');
        }
      } catch (error) {
        throw new Error('เนเธกเนเธชเธฒเธกเธฒเธฃเธ–เธ”เธถเธเธเนเธญเธกเธนเธฅเธเธเธฑเธเธเธฒเธเนเธ”เน');
      }
    }

    // Handle Internal Training differently
    if (type === 'internal_training') {
      const internalTrainingData = {
        employee_id: finalEmployeeData.id,
        employee_name: finalEmployeeData.Name || user.email || 'Unknown User',
        request_type: 'internal_training',
        status: 'pending_manager',
        title: data.courseName || '',
        details: data.additionalNotes || data.details || '',
        amount: Number(data.totalAmount || data.amount || 0),
        department_request: finalEmployeeData.Team || 'Unknown Department',
        department: data.department || finalEmployeeData.Team || 'Unknown Department',
        branch: data.branch || null,
        course_name: data.courseName || '',
        start_date: data.startDate || null,
        end_date: data.endDate || null,
        start_time: data.startTime || null,
        end_time: data.endTime || null,
        total_hours: Number(data.totalHours || 0),
        venue: data.venue || null,
        participants: data.participants ? JSON.stringify(data.participants) : null,
        total_participants: Number(data.totalParticipants || 0),
        instructor_fee: Number(data.instructorFee || 0),
        instructor_fee_withholding: Number(data.instructorFeeWithholding || 0),
        instructor_fee_vat: Number(data.instructorFeeVat || 0),
        instructor_fee_total: Number(data.instructorFeeTotal || 0),
        room_food_beverage: Number(data.roomFoodBeverage || 0),
        room_food_beverage_withholding: Number(data.roomFoodBeverageWithholding || 0),
        room_food_beverage_vat: Number(data.roomFoodBeverageVat || 0),
        room_food_beverage_total: Number(data.roomFoodBeverageTotal || 0),
        other_expenses: Number(data.otherExpenses || 0),
        other_expenses_withholding: Number(data.otherExpensesWithholding || 0),
        other_expenses_vat: Number(data.otherExpensesVat || 0),
        other_expenses_total: Number(data.otherExpensesTotal || 0),
        withholding_tax: Number(data.withholdingTax || 0),
        vat: Number(data.vat || 0),
        total_amount: Number(data.totalAmount || 0),
        average_cost_per_person: Number(data.averageCostPerPerson || 0),
        tax_certificate_name: data.taxCertificateName || null,
        withholding_tax_amount: Number(data.withholdingTaxAmount || 0),
        additional_notes: data.additionalNotes || null,
        is_vat_included: Boolean(data.isVatIncluded),
        userSignature: signature || userSignature, // Add user signature
        user_signature: signature || userSignature, // Add alternative field name
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        user_name: finalEmployeeData.Name || user.email || 'Unknown User'
      };

      const result = await submitInternalTrainingRequest(internalTrainingData);
      if (!result) {
        throw new Error('Failed to submit internal training request');
      }

      // Generate PDF and upload to Supabase
      try {
        const { generateInternalTrainingPDF } = await import('../pdf/InternalTrainingPDFGenerator');
        const blob = await generateInternalTrainingPDF(
          {
            ...internalTrainingData,
            id: result.id || Date.now(),
            status: 'pending_manager' as const,
            created_at: internalTrainingData.created_at,
            updated_at: internalTrainingData.updated_at,
            userSignature: signature || userSignature, // Add user signature
            user_signature: signature || userSignature // Add alternative field name
          } as any,
          user as any,
          finalEmployeeData,
          undefined, // managerSignature
          undefined, // hrSignature
          signature || userSignature // userSignature
        );

        // Create safe filename
        const employeeId = finalEmployeeData?.employee_id || user?.id?.slice(-8) || 'user';
        const timestamp = Date.now();
        const filename = `internal_training_emp${employeeId}_${timestamp}.pdf`;
        const pdfUrl = await uploadPDFToSupabase(blob, filename, user?.id);

        // Update the request with the PDF URL
        if (result.id && pdfUrl) {
          await supabase.from('welfare_requests').update({ pdf_url: pdfUrl }).eq('id', result.id);
        }

        toast({
          title: 'เธชเนเธเธเธณเธฃเนเธญเธเนเธฅเธฐเธญเธฑเธเนเธซเธฅเธ” PDF เธชเธณเน€เธฃเนเธ',
          description: 'เธเธณเธฃเนเธญเธเธเธฒเธฃเธญเธเธฃเธกเธ เธฒเธขเนเธเธเธญเธเธเธธเธ“เธ–เธนเธเธชเนเธเน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง เนเธฅเธฐ PDF เนเธ”เนเธ–เธนเธเธเธฑเธเธ—เธถเธเนเธเธฃเธฐเธเธเนเธฅเนเธง',
        });
      } catch (pdfError) {
        console.error('PDF generation/upload error:', pdfError);
        toast({
          title: 'เธชเนเธเธเธณเธฃเนเธญเธเธชเธณเน€เธฃเนเธ',
          description: 'เธเธณเธฃเนเธญเธเธเธญเธเธเธธเธ“เธ–เธนเธเธชเนเธเน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง เนเธ•เนเนเธกเนเธชเธฒเธกเธฒเธฃเธ–เธชเธฃเนเธฒเธ/เธญเธฑเธเนเธซเธฅเธ” PDF เนเธ”เนเนเธเธเธ“เธฐเธเธตเน',
        });
      }

      await refreshInternalTrainingRequests();
      
      toast({
        title: 'เธชเนเธเธเธณเธฃเนเธญเธเธชเธณเน€เธฃเนเธ',
        description: 'เธเธณเธฃเนเธญเธเธเธฒเธฃเธญเธเธฃเธกเธ เธฒเธขเนเธเธเธญเธเธเธธเธ“เธ–เธนเธเธชเนเธเน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง เนเธฅเธฐเธญเธขเธนเนเนเธเธฃเธฐเธซเธงเนเธฒเธเธเธฒเธฃเธเธดเธเธฒเธฃเธ“เธฒ',
      });

      reset();
      setFiles([]);
      setTimeout(onBack, 2000);
      return result;
    }

    // CREATE NEW REQUEST (for other welfare types)
    const requestData = {
      userId: profile.employee_id.toString(),
      userName: finalEmployeeData?.Name || user?.email || 'Unknown User',
      userDepartment: finalEmployeeData?.Team || 'Unknown Department',
      department_request: finalEmployeeData?.Team || 'Unknown Department',
      type: type,
      status: 'pending' as const,
      amount: Number(data.netAmount || data.amount || 0),
      date: data.startDate || new Date().toISOString(),
      details: data.details || '',
      attachments: files,
      notes: '',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      managerId: finalEmployeeData?.Position,
      start_date: data.startDate,
      end_date: data.endDate,
      total_days: data.totalDays,
      birth_type: data.birthType,
      funeral_type: data.funeralType,
      training_topics: data.trainingTopics ? JSON.stringify(data.trainingTopics) : null,
      total_amount: data.totalAmount,
      tax7_percent: data.tax7Percent,
      withholding_tax3_percent: data.withholdingTax3Percent,
      net_amount: data.netAmount,
      excess_amount: data.excessAmount,
      company_payment: data.companyPayment,
      employee_payment: data.employeePayment,
      course_name: data.courseName,
      organizer: data.organizer,
      is_vat_included: data.isVatIncluded,
      userSignature: signature || userSignature, // เน€เธเธดเนเธกเธฅเธฒเธขเน€เธเนเธ
      // Advance fields for requestData
      advanceDepartment: data.advanceDepartment,
      advanceDistrict: data.advanceDistrict,
      advanceActivityType: data.advanceActivityType,
      advanceActivityOther: data.advanceActivityOther,
      advanceShopCompany: data.advanceShopCompany,
      advanceAmphur: data.advanceAmphur,
      advanceProvince: data.advanceProvince,
      advanceEventDate: data.advanceEventDate,
      advanceParticipants: data.advanceParticipants,
      advanceDailyRate: data.advanceDailyRate,
      advanceAccommodationCost: data.advanceAccommodationCost,
      advanceTransportationCost: data.advanceTransportationCost,
      advanceMealAllowance: data.advanceMealAllowance,
      advanceOtherExpenses: data.advanceOtherExpenses,
      advanceProjectName: data.advanceProjectName,
      advanceProjectLocation: data.advanceProjectLocation,
      // Attachment selections for PDF mapping
      attachmentSelections: data.attachmentSelections,
    };

    const result = await submitRequest(requestData);
    if (!result) {
      throw new Error('Failed to submit request');
    }

    await refreshRequests();
    // Generate PDF and upload to Supabase
    try {
      let blob: Blob;

      if (type === 'training') {
        // Use Training PDF Generator for training type
        blob = await generateTrainingPDF(
          {
            ...requestData,
            id: result.id || Date.now(),
            status: 'pending_manager' as const,
            createdAt: requestData.createdAt,
            updatedAt: requestData.updatedAt,
            userSignature: signature || userSignature
          },
          user as any,
          finalEmployeeData,
          signature || userSignature,
          remainingBudget
        );
      } else if (type === 'advance') {
        // Use Advance PDF Generator for advance type
        blob = await generateAdvancePDF(
          {
            ...requestData,
            id: result.id || Date.now(),
            status: 'pending_manager' as const,
            createdAt: requestData.createdAt,
            updatedAt: requestData.updatedAt,
            userSignature: signature || userSignature
          },
          user as any,
          finalEmployeeData,
          signature || userSignature
        );
      } else {
        // Use Welfare PDF Generator for other types
        blob = await generateWelfarePDF(
          {
            ...requestData,
            id: result.id || Date.now(),
            status: 'pending_manager' as const,
            createdAt: requestData.createdAt,
            updatedAt: requestData.updatedAt,
            userSignature: signature || userSignature
          },
          user as any,
          finalEmployeeData
        );
      }
      // เธชเธฃเนเธฒเธเธเธทเนเธญเนเธเธฅเนเธ—เธตเนเธเธฅเธญเธ”เธ เธฑเธขเนเธ”เธขเนเธเน employee_id เธซเธฃเธทเธญ timestamp เนเธ—เธเธเธทเนเธญเนเธ—เธข
      const employeeId = finalEmployeeData?.employee_id || user?.id?.slice(-8) || 'user';
      const timestamp = Date.now();
      const filename = `welfare_${requestData.type}_emp${employeeId}_${timestamp}.pdf`;
      const pdfUrl = await uploadPDFToSupabase(blob, filename, user?.id);
      // Update the request with the PDF URL
      if (result.id && pdfUrl) {
        await supabase.from('welfare_requests').update({ pdf_url: pdfUrl }).eq('id', result.id);
      }
      toast({
        title: 'เธชเนเธเธเธณเธฃเนเธญเธเนเธฅเธฐเธญเธฑเธเนเธซเธฅเธ” PDF เธชเธณเน€เธฃเนเธ',
        description: 'เธเธณเธฃเนเธญเธเธเธญเธเธเธธเธ“เธ–เธนเธเธชเนเธเน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง เนเธฅเธฐ PDF เนเธ”เนเธ–เธนเธเธเธฑเธเธ—เธถเธเนเธเธฃเธฐเธเธเนเธฅเนเธง',
      });
    } catch (pdfError) {
      console.error('PDF generation/upload error:', pdfError);
      toast({
        title: 'เธชเนเธเธเธณเธฃเนเธญเธเธชเธณเน€เธฃเนเธ',
        description: 'เธเธณเธฃเนเธญเธเธเธญเธเธเธธเธ“เธ–เธนเธเธชเนเธเน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง เนเธ•เนเนเธกเนเธชเธฒเธกเธฒเธฃเธ–เธชเธฃเนเธฒเธ/เธญเธฑเธเนเธซเธฅเธ” PDF เนเธ”เนเนเธเธเธ“เธฐเธเธตเน',
      });
    }

    toast({
      title: 'เธชเนเธเธเธณเธฃเนเธญเธเธชเธณเน€เธฃเนเธ',
      description: 'เธเธณเธฃเนเธญเธเธเธญเธเธเธธเธ“เธ–เธนเธเธชเนเธเน€เธฃเธตเธขเธเธฃเนเธญเธขเนเธฅเนเธง เนเธฅเธฐเธญเธขเธนเนเนเธเธฃเธฐเธซเธงเนเธฒเธเธเธฒเธฃเธเธดเธเธฒเธฃเธ“เธฒ',
    });


    reset();
    setFiles([]);
    setUserSignature('');
    setTimeout(onBack, 2000);
  };



  // 3. เธญเธฑเธเน€เธ”เธ•เธเธฑเธเธเนเธเธฑเธ calculateTrainingAmounts
  const calculateTrainingAmounts = (total: number, remainingBudget: number, customVat?: number, customWithholding?: number) => {
    // เธ•เธฃเธงเธเธชเธญเธเธเนเธฒเธ—เธตเนเธชเนเธเน€เธเนเธฒเธกเธฒ
    if (typeof total !== 'number' || isNaN(total) || total < 0) return;
    if (typeof remainingBudget !== 'number' || isNaN(remainingBudget)) remainingBudget = 0;

    // เนเธเนเธเนเธฒเธ—เธตเนเธเธนเนเนเธเนเธเธฃเธญเธเนเธ”เธขเธ•เธฃเธ เธซเธฃเธทเธญ 0 เธ–เนเธฒเนเธกเนเนเธ”เนเธเธฃเธญเธ
    const vat = customVat !== undefined && !isNaN(customVat) ? customVat : 0;
    const withholding = customWithholding !== undefined && !isNaN(customWithholding) ? customWithholding : 0;

    const grossAmount = total + vat;
    const remainingNum = Number(remainingBudget) || 0;

    let netNum = 0;
    let excessAmountValue = 0;
    let companyPaymentValue = 0;
    let employeePaymentValue = 0;

    if (grossAmount > remainingNum) {
      // --- เธเธฃเธ“เธตเน€เธเธดเธเธเธเธเธฃเธฐเธกเธฒเธ“ ---
      excessAmountValue = grossAmount - remainingNum;
      netNum = grossAmount - withholding; // เนเธเนเนเธ: เธฅเธเธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธข

      companyPaymentValue = excessAmountValue / 2;
      employeePaymentValue = (excessAmountValue / 2) + withholding; // เธเธเธฑเธเธเธฒเธเธ•เนเธญเธเธเนเธฒเธขเธชเนเธงเธเน€เธเธดเธ + เธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธข

    } else {
      // --- เธเธฃเธ“เธตเนเธกเนเน€เธเธดเธเธเธเธเธฃเธฐเธกเธฒเธ“ ---
      netNum = grossAmount - withholding; // เนเธเนเนเธ: เธฅเธเธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธข
      excessAmountValue = 0;
      companyPaymentValue = 0;
      employeePaymentValue = 0; // no payment when under budget
    }

    // --- เธญเธฑเธเน€เธ”เธ•เธเนเธฒเธ—เธฑเนเธเธซเธกเธ”เนเธเธขเธฑเธเธเธญเธฃเนเธก ---
    setValue('totalAmount', parseFloat((total || 0).toFixed(2)));
    setValue('netAmount', parseFloat((netNum || 0).toFixed(2)));
    setValue('excessAmount', parseFloat((excessAmountValue || 0).toFixed(2))); // เธ•เธฑเนเธเธเนเธฒ Field เนเธซเธกเน
    setValue('companyPayment', parseFloat((companyPaymentValue || 0).toFixed(2)));
    setValue('employeePayment', parseFloat((employeePaymentValue || 0).toFixed(2)));
  };

  // เธเธฑเธเธเนเธเธฑเธเธเธณเธเธงเธ“เธชเธณเธซเธฃเธฑเธ welfare types เธญเธทเนเธ เน (เนเธกเนเนเธเน training)
  const calculateNonTrainingAmounts = (total: number, customVat?: number, customWithholding?: number) => {
    // เธ•เธฃเธงเธเธชเธญเธเธเนเธฒเธ—เธตเนเธชเนเธเน€เธเนเธฒเธกเธฒ
    if (typeof total !== 'number' || isNaN(total) || total < 0) return;

    // เนเธเนเธเนเธฒเธ—เธตเนเธเธนเนเนเธเนเธเธฃเธญเธเนเธ”เธขเธ•เธฃเธ เธซเธฃเธทเธญ 0 เธ–เนเธฒเนเธกเนเนเธ”เนเธเธฃเธญเธ
    const vat = customVat !== undefined && !isNaN(customVat) ? customVat : 0;
    const withholding = customWithholding !== undefined && !isNaN(customWithholding) ? customWithholding : 0;

    const netAmount = total + vat - withholding;

    // เธญเธฑเธเน€เธ”เธ•เธเนเธฒเธ—เธฑเนเธเธซเธกเธ”เนเธเธขเธฑเธเธเธญเธฃเนเธก
    setValue('totalAmount', parseFloat((total || 0).toFixed(2)));
    setValue('netAmount', parseFloat((netAmount || 0).toFixed(2)));
  };

  // Add function to calculate total days
  const calculateTotalDays = (start: string, end: string) => {
    if (!start || !end) return 0;
    const startDate = new Date(start);
    const endDate = new Date(end);
    const diffTime = Math.abs(endDate.getTime() - startDate.getTime());
    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end dates
    return totalDays;
  };

  return (
    <div className="animate-fade-in">
      <Button
        variant="ghost"
        className="mb-6"
        onClick={onBack}
      >
        <ArrowLeft className="mr-2 h-4 w-4" />
        เธเธฅเธฑเธ
      </Button>

      <div id="welfare-form-content" className="form-container">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-2xl font-bold">{getFormTitle(type)}</h1>
        </div>

        {/* Display welfare limits for non-training types */}
        {maxAmount !== null && type !== 'training' && type !== 'internal_training' && type !== 'advance' && (
          <div className="mb-6">
            <Alert>
              <AlertCircle className="h-4 w-4 mr-2" />
              <AlertDescription>
                {type === 'childbirth' ? (
                  <>เธเธฅเธญเธ”เธเธฃเธฃเธกเธเธฒเธ•เธด 4,000 เธเธฒเธ—, เธเนเธฒเธเธฅเธญเธ” 6,000 เธเธฒเธ—</>
                ) : (
                  <>เธงเธเน€เธเธดเธเธชเธนเธเธชเธธเธ”: {isMonthly ? `${maxAmount} เธเธฒเธ—/เน€เธ”เธทเธญเธ` : `${maxAmount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} เธเธฒเธ—/เธเธต`}</>
                )}
                {condition && <> ({condition})</>}
              </AlertDescription>
            </Alert>
          </div>
        )}
        {user && type !== 'training' && type !== 'internal_training' && type !== 'advance' && (
          <div className="mb-6">
            <p className="text-sm font-medium text-gray-700">
              เธเธเธเธฃเธฐเธกเธฒเธ“เธเธเน€เธซเธฅเธทเธญเธชเธณเธซเธฃเธฑเธเธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเธตเน: <span className="font-bold text-welfare-blue">{remainingBudget.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} เธเธฒเธ—</span>
            </p>
          </div>
        )}
        {type === 'training' && (
          <div className="space-y-4 mb-6">
            <Alert>
              <AlertCircle className="h-4 w-4 mr-2" />
              <AlertDescription>
                เธงเธเน€เธเธดเธเธชเธนเธเธชเธธเธ”: {maxAmount?.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) || '0.00'} เธเธฒเธ—
              </AlertDescription>
            </Alert>
            <Alert>
              <AlertCircle className="h-4 w-4 mr-2" />
              <AlertDescription>
                เธเธเธเธฃเธฐเธกเธฒเธ“เธเธเน€เธซเธฅเธทเธญ: {remainingBudget?.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) || '0.00'} เธเธฒเธ—
              </AlertDescription>
            </Alert>
            {workDaysError && (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4 mr-2" />
                <AlertDescription>
                  {workDaysError}
                </AlertDescription>
              </Alert>
            )}
            {employeeData?.start_date && !workDaysError && (
              <Alert>
                <AlertCircle className="h-4 w-4 mr-2" />
                <AlertDescription>
                  เธญเธฒเธขเธธเธเธฒเธ: {calculateWorkDays(employeeData.start_date)} เธงเธฑเธ (เน€เธเนเธฒเธ—เธณเธเธฒเธเธงเธฑเธเธ—เธตเน {new Date(employeeData.start_date).toLocaleDateString('th-TH')})
                </AlertDescription>
              </Alert>
            )}
          </div>
        )}

        {/* Special info for advance payment */}
        {type === 'advance' && (
          <div className="mb-6">
            <Alert className="border-blue-200 bg-blue-50">
              <AlertCircle className="h-4 w-4 mr-2 text-blue-600" />
              <AlertDescription className="text-blue-800">
                <strong>เน€เธเธดเธเน€เธเธดเธเธ—เธ”เธฅเธญเธ:</strong> เธชเธฒเธกเธฒเธฃเธ–เธเธญเธญเธเธธเธกเธฑเธ•เธดเนเธ”เนเธ•เธฅเธญเธ”เน€เธงเธฅเธฒ เนเธกเนเธกเธตเธเนเธญเธเธณเธเธฑเธ”เน€เธฃเธทเนเธญเธเธงเธเน€เธเธดเธเธซเธฃเธทเธญเธเธเธเธฃเธฐเธกเธฒเธ“ เธฃเธฐเธเธเธเธฐเธเธณเธเธงเธ“เธเธณเธเธงเธเน€เธเธดเธเนเธซเนเธญเธฑเธ•เนเธเธกเธฑเธ•เธดเธ•เธฒเธกเธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เธ—เธตเนเธเธฃเธญเธ
              </AlertDescription>
            </Alert>
          </div>
        )}

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          {/* Training specific fields */}
          {type === 'training' && (
            <>
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="form-label">เธซเธฅเธฑเธเธชเธนเธ•เธฃ</label>
                  <Input
                    placeholder="เธฃเธฐเธเธธเธเธทเนเธญเธซเธฅเธฑเธเธชเธนเธ•เธฃ"
                    className="form-input"
                    {...register('courseName', {
                      required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธเธทเนเธญเธซเธฅเธฑเธเธชเธนเธ•เธฃ'
                    })}
                  />
                  {errors.courseName && (
                    <p className="text-red-500 text-sm mt-1">{errors.courseName.message}</p>
                  )}
                </div>
                <div className="space-y-2">
                  <label className="form-label">เธเธฑเธ”เธเธถเนเธเนเธ”เธข</label>
                  <Input
                    placeholder="เธฃเธฐเธเธธเธเธทเนเธญเธเธนเนเธเธฑเธ”"
                    className="form-input"
                    {...register('organizer', {
                      required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธเธนเนเธเธฑเธ”'
                    })}
                  />
                  {errors.organizer && (
                    <p className="text-red-500 text-sm mt-1">{errors.organizer.message}</p>
                  )}
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <div className="space-y-2">
                  <label className="form-label">เธ•เธฑเนเธเนเธ•เนเธงเธฑเธเธ—เธตเน</label>
                  <Input
                    type="date"
                    className="form-input"
                    {...register('startDate', {
                      required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธงเธฑเธเธ—เธตเนเน€เธฃเธดเนเธก',
                      onChange: (e) => {
                        const endDate = watch('endDate');
                        if (endDate && e.target.value > endDate) {
                          setValue('endDate', e.target.value);
                        }
                      }
                    })}
                  />
                  {errors.startDate && (
                    <p className="text-red-500 text-sm mt-1">{errors.startDate.message}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <label className="form-label">เธ–เธถเธเธงเธฑเธเธ—เธตเน</label>
                  <Input
                    type="date"
                    className="form-input"
                    {...register('endDate', {
                      required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธงเธฑเธเธ—เธตเนเธชเธดเนเธเธชเธธเธ”',
                      validate: value => {
                        const startDate = watch('startDate');
                        return !value || !startDate || value >= startDate || 'เธงเธฑเธเธ—เธตเนเธชเธดเนเธเธชเธธเธ”เธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒเธงเธฑเธเธ—เธตเนเน€เธฃเธดเนเธก';
                      }
                    })}
                  />
                  {errors.endDate && (
                    <p className="text-red-500 text-sm mt-1">{errors.endDate.message}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <label className="form-label">เธฃเธงเธกเน€เธเนเธเธเธณเธเธงเธ</label>
                  <div className="flex items-center gap-2">
                    <Input
                      type="number"
                      className="form-input"
                      readOnly
                      {...register('totalDays')}
                    />
                    <span className="text-sm">เธงเธฑเธ</span>
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <label className="form-label">เนเธ”เธขเธกเธตเธงเธฑเธ•เธ–เธธเธเธฃเธฐเธชเธเธเนเธ—เธตเนเธเธญเน€เธเนเธฒเธญเธเธฃเธก เธ”เธฑเธเธเธตเน</label>
                <div className="space-y-2">
                  {fields.map((field, index) => (
                    <div key={field.id} className="flex items-center gap-2">
                      <Input
                        {...register(`trainingTopics.${index}.value` as const)}
                        placeholder={`เธงเธฑเธ•เธ–เธธเธเธฃเธฐเธชเธเธเนเธ—เธตเน ${index + 1}`}
                        className="form-input"
                      />
                      {fields.length > 2 && (
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          onClick={() => remove(index)}
                        >
                          <X className="h-4 w-4" />
                        </Button>
                      )}
                    </div>
                  ))}
                  {fields.length < 5 && (
                    <Button
                      type="button"
                      onClick={() => append({ value: '' })}
                      className="mt-2"
                      variant="outline"
                    >
                      <Plus className="mr-2 h-4 w-4" />
                      เน€เธเธดเนเธกเธงเธฑเธ•เธ–เธธเธเธฃเธฐเธชเธเธเน
                    </Button>
                  )}
                </div>
              </div>
              <div className="space-y-2">
                <label htmlFor="amount" className="form-label">เธเธณเธเธงเธเน€เธเธดเธ</label>
                <Input
                  id="amount"
                  type="number"
                  step="0.01"
                  className="form-input"
                  placeholder="เธฃเธฐเธเธธเธเธณเธเธงเธเน€เธเธดเธ"
                  {...register('amount', {
                    required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธเธณเธเธงเธเน€เธเธดเธ',
                    min: {
                      value: 1,
                      message: 'เธเธณเธเธงเธเน€เธเธดเธเธ•เนเธญเธเธกเธฒเธเธเธงเนเธฒ 0'
                    },
                    onChange: (e) => {
                      const amount = Number(e.target.value);
                      const vatAmount = Number(watch('tax7Percent')) || 0;
                      const withholdingAmount = Number(watch('withholdingTax3Percent')) || 0;
                      calculateTrainingAmounts(amount, remainingBudget, vatAmount, withholdingAmount);
                    }
                  })}
                />
                {errors.amount && (
                  <p className="text-red-500 text-sm mt-1">{errors.amount.message}</p>
                )}
              </div>



              <div className="grid grid-cols-3 gap-4">
                <div className="space-y-2">
                  <label className="form-label">เธ เธฒเธฉเธตเธกเธนเธฅเธเนเธฒเน€เธเธดเนเธก (7%)</label>
                  <Input
                    type="number"
                    className="form-input"
                    step="0.01"
                    min="0"
                    placeholder="0.00"
                    defaultValue="0"
                    {...register('tax7Percent', {
                      min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' },
                      onChange: (e) => {
                        const amount = watch('amount');
                        const vatAmount = Number(e.target.value) || 0;
                        const withholdingAmount = Number(watch('withholdingTax3Percent')) || 0;
                        if (amount) {
                          calculateTrainingAmounts(Number(amount), remainingBudget, vatAmount, withholdingAmount);
                        }
                      }
                    })}
                  />
                  {errors.tax7Percent && (
                    <p className="text-red-500 text-sm mt-1">{errors.tax7Percent.message}</p>
                  )}
                </div>
                <div className="space-y-2">
                  <label className="form-label">เธซเธฑเธเธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธข (3%)</label>
                  <Input
                    type="number"
                    className="form-input"
                    step="0.01"
                    min="0"
                    placeholder="0.00"
                    defaultValue="0"
                    {...register('withholdingTax3Percent', {
                      min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' },
                      onChange: (e) => {
                        const amount = watch('amount');
                        const withholdingAmount = Number(e.target.value) || 0;
                        const vatAmount = Number(watch('tax7Percent')) || 0;
                        if (amount) {
                          calculateTrainingAmounts(Number(amount), remainingBudget, vatAmount, withholdingAmount);
                        }
                      }
                    })}
                  />
                  {errors.withholdingTax3Percent && (
                    <p className="text-red-500 text-sm mt-1">{errors.withholdingTax3Percent.message}</p>
                  )}
                </div>
                <div className="space-y-2">
                  <label className="form-label">เธเธณเธเธงเธเน€เธเธดเธเธชเธธเธ—เธเธด</label>
                  <Input
                    type="number"
                    step="0.01"
                    className="form-input bg-gray-100"
                    readOnly
                    value={watch('netAmount') ? Number(watch('netAmount')).toFixed(2) : ''}
                    {...register('netAmount')}
                  />
                </div>
              </div>

              {/* 2. เน€เธเธดเนเธก Field 'เธขเธญเธ”เธชเนเธงเธเน€เธเธดเธเธ—เธฑเนเธเธซเธกเธ”' เนเธเธซเธเนเธฒเธเธญเธฃเนเธก (JSX) */}
              <div className="space-y-2">
                <label className="form-label">เธขเธญเธ”เธชเนเธงเธเน€เธเธดเธเธ—เธฑเนเธเธซเธกเธ”</label>
                <Input
                  type="number"
                  step="0.01"
                  className="form-input bg-gray-100"
                  readOnly
                  value={watch('excessAmount') ? Number(watch('excessAmount')).toFixed(2) : ''}
                  {...register('excessAmount')}
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="form-label">เธเธฃเธดเธฉเธฑเธ—เธเนเธฒเธข</label>
                  <Input
                    type="number"
                    step="0.01"
                    className="form-input bg-gray-100"
                    readOnly
                    value={watch('companyPayment') ? Number(watch('companyPayment')).toFixed(2) : ''}
                    {...register('companyPayment')}
                  />
                </div>
                <div className="space-y-2">
                  <label className="form-label">เธเธเธฑเธเธเธฒเธเธเนเธฒเธข</label>
                  <Input
                    type="number"
                    step="0.01"
                    className="form-input bg-gray-100"
                    readOnly
                    value={watch('employeePayment') ? Number(watch('employeePayment')).toFixed(2) : ''}
                    {...register('employeePayment')}
                  />
                </div>
              </div>
            </>
          )}

          {/* Funeral specific fields */}
          {type === 'funeral' && (
            <div className="space-y-2">
              <label className="form-label">เธเธฃเธฐเน€เธ เธ—เธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเธฒเธเธจเธ</label>
              <Select
                onValueChange={(value) => setValue('funeralType', value as 'employee_spouse' | 'child' | 'parent')}
                defaultValue={watch('funeralType')}
                {...register('funeralType', {
                  required: type === 'funeral' ? 'เธเธฃเธธเธ“เธฒเน€เธฅเธทเธญเธเธเธฃเธฐเน€เธ เธ—เธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเธฒเธเธจเธ' : false
                })}
              >
                <SelectTrigger className="form-input">
                  <SelectValue placeholder="เน€เธฅเธทเธญเธเธเธฃเธฐเน€เธ เธ—เธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเธฒเธเธจเธ" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="employee_spouse">เธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเธฒเธเธจเธ เธเธเธฑเธเธเธฒเธ/เธชเธฒเธกเธตเธซเธฃเธทเธญเธ เธฃเธฃเธขเธฒเธเธญเธเธเธเธฑเธเธเธฒเธ</SelectItem>
                  <SelectItem value="child">เธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเธฒเธเธจเธ เธเธธเธ•เธฃ เธเธญเธเธเธเธฑเธเธเธฒเธ</SelectItem>
                  <SelectItem value="parent">เธชเธงเธฑเธชเธ”เธดเธเธฒเธฃเธเธฒเธเธจเธ เธเธดเธ”เธฒ/เธกเธฒเธฃเธ”เธฒ เธเธญเธเธเธเธฑเธเธเธฒเธ</SelectItem>
                </SelectContent>
              </Select>
              {errors.funeralType && (
                <p className="text-red-500 text-sm mt-1">{errors.funeralType.message}</p>
              )}
            </div>
          )}

          {/* Internal Training specific fields */}
          {type === 'internal_training' && (
            <>
              {/* เธชเนเธงเธเธ—เธตเน 1: เธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เธเธฒเธฃเธญเธเธฃเธก */}
              <div className="space-y-6">
                <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">เธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เธเธฒเธฃเธญเธเธฃเธก</h3>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="form-label">เธเนเธฒเธข/เนเธเธเธเธเธนเนเธเธญเธญเธเธธเธกเธฑเธ•เธด</label>
                    <Select
                      onValueChange={(value) => setValue('department', value)}
                      defaultValue={watch('department')}
                    >
                      <SelectTrigger className="form-input">
                        <SelectValue placeholder="เน€เธฅเธทเธญเธเธเนเธฒเธข/เนเธเธเธ" />
                      </SelectTrigger>
                      <SelectContent>
                        {DEPARTMENTS.map((dept) => (
                          <SelectItem key={dept} value={dept}>{dept}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เธชเธฒเธเธฒ</label>
                    <Select
                      onValueChange={(value) => setValue('branch', value)}
                      defaultValue={watch('branch')}
                    >
                      <SelectTrigger className="form-input">
                        <SelectValue placeholder="เน€เธฅเธทเธญเธเธชเธฒเธเธฒ" />
                      </SelectTrigger>
                      <SelectContent>
                        {BRANCHES.map((branch) => (
                          <SelectItem key={branch} value={branch}>{branch}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="form-label">เธเธทเนเธญเธซเธฅเธฑเธเธชเธนเธ•เธฃ/เธซเธฑเธงเธเนเธญเธญเธเธฃเธก</label>
                  <Input
                    placeholder="เธฃเธฐเธเธธเธเธทเนเธญเธซเธฅเธฑเธเธชเธนเธ•เธฃเธซเธฃเธทเธญเธซเธฑเธงเธเนเธญเธญเธเธฃเธก"
                    className="form-input"
                    {...register('courseName', {
                      required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธเธทเนเธญเธซเธฅเธฑเธเธชเธนเธ•เธฃเธซเธฃเธทเธญเธซเธฑเธงเธเนเธญเธญเธเธฃเธก'
                    })}
                  />
                  {errors.courseName && (
                    <p className="text-red-500 text-sm mt-1">{errors.courseName.message}</p>
                  )}
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="form-label">เธงเธฑเธเธ—เธตเนเน€เธฃเธดเนเธกเธญเธเธฃเธก</label>
                    <Input
                      type="date"
                      className="form-input"
                      {...register('startDate', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธงเธฑเธเธ—เธตเนเน€เธฃเธดเนเธกเธญเธเธฃเธก'
                      })}
                    />
                    {errors.startDate && (
                      <p className="text-red-500 text-sm mt-1">{errors.startDate.message}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เธงเธฑเธเธ—เธตเนเธชเธดเนเธเธชเธธเธ”เธญเธเธฃเธก</label>
                    <Input
                      type="date"
                      className="form-input"
                      {...register('endDate', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธงเธฑเธเธ—เธตเนเธชเธดเนเธเธชเธธเธ”เธญเธเธฃเธก',
                        validate: value => {
                          const startDate = watch('startDate');
                          return !value || !startDate || value >= startDate || 'เธงเธฑเธเธ—เธตเนเธชเธดเนเธเธชเธธเธ”เธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒเธงเธฑเธเธ—เธตเนเน€เธฃเธดเนเธก';
                        }
                      })}
                    />
                    {errors.endDate && (
                      <p className="text-red-500 text-sm mt-1">{errors.endDate.message}</p>
                    )}
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  <div className="space-y-2">
                    <label className="form-label">เน€เธงเธฅเธฒเน€เธฃเธดเนเธก</label>
                    <Input
                      type="time"
                      className="form-input"
                      {...register('startTime', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเน€เธงเธฅเธฒเน€เธฃเธดเนเธก'
                      })}
                    />
                    {errors.startTime && (
                      <p className="text-red-500 text-sm mt-1">{errors.startTime.message}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เน€เธงเธฅเธฒเธชเธดเนเธเธชเธธเธ”</label>
                    <Input
                      type="time"
                      className="form-input"
                      {...register('endTime', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเน€เธงเธฅเธฒเธชเธดเนเธเธชเธธเธ”'
                      })}
                    />
                    {errors.endTime && (
                      <p className="text-red-500 text-sm mt-1">{errors.endTime.message}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เธฃเธงเธกเธฃเธฐเธขเธฐเน€เธงเธฅเธฒเธเธฒเธฃเธญเธเธฃเธก (เธเธฑเนเธงเนเธกเธ)</label>
                    <Input
                      type="number"
                      step="0.01"
                      className="form-input bg-gray-100"
                      readOnly
                      value={watch('totalHours') ? Number(watch('totalHours')).toFixed(2) : ''}
                      {...register('totalHours')}
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="form-label">เธชเธ–เธฒเธเธ—เธตเนเธเธถเธเธญเธเธฃเธก</label>
                  <Input
                    placeholder="เธฃเธฐเธเธธเธชเธ–เธฒเธเธ—เธตเนเธเธถเธเธญเธเธฃเธก"
                    className="form-input"
                    {...register('venue', {
                      required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธชเธ–เธฒเธเธ—เธตเนเธเธถเธเธญเธเธฃเธก'
                    })}
                  />
                  {errors.venue && (
                    <p className="text-red-500 text-sm mt-1">{errors.venue.message}</p>
                  )}
                </div>
              </div>

              {/* เธชเนเธงเธเธ—เธตเน 2: เธเธณเธเธงเธเธเธนเนเน€เธเนเธฒเธฃเนเธงเธกเธญเธเธฃเธก */}
              <div className="space-y-6">
                <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">เธเธณเธเธงเธเธเธนเนเน€เธเนเธฒเธฃเนเธงเธกเธญเธเธฃเธก</h3>

                <div className="space-y-4">
                  <label className="form-label">เน€เธฅเธทเธญเธเธ—เธตเธกเนเธฅเธฐเธเธนเนเน€เธเนเธฒเธฃเนเธงเธกเธญเธเธฃเธก</label>
                  <div className="space-y-6">
                    {participantFields.map((field, index) => {
                      const currentParticipant = watch(`participants.${index}`);
                      return (
                        <div key={field.id} className="space-y-4 border rounded-lg p-4">
                          <div className="flex items-center justify-between">
                            <span className="text-sm font-medium text-gray-600">เธ—เธตเธกเธ—เธตเน {index + 1}</span>
                            {participantFields.length > 1 && (
                              <Button
                                type="button"
                                variant="ghost"
                                size="sm"
                                onClick={() => removeParticipant(index)}
                              >
                                <X className="h-4 w-4" />
                                เธฅเธเธ—เธตเธก
                              </Button>
                            )}
                          </div>

                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="text-sm text-gray-600 mb-1 block">เน€เธฅเธทเธญเธเธ—เธตเธก:</label>
                              <Select
                                onValueChange={(value) => {
                                  setValue(`participants.${index}.team`, value);
                                  // Reset selected participants when team changes
                                  setValue(`participants.${index}.selectedParticipants`, []);
                                }}
                                value={currentParticipant?.team || ''}
                              >
                                <SelectTrigger className="form-input">
                                  <SelectValue placeholder="เน€เธฅเธทเธญเธเธ—เธตเธก" />
                                </SelectTrigger>
                                <SelectContent>
                                  {TEAMS.map((team) => (
                                    <SelectItem key={team} value={team}>{team}</SelectItem>
                                  ))}
                                </SelectContent>
                              </Select>
                            </div>

                            <div>
                              <label className="text-sm text-gray-600 mb-1 block">เธเธณเธเธงเธเธเธนเนเน€เธเนเธฒเธฃเนเธงเธก:</label>
                              <Input
                                type="number"
                                min="0"
                                max="50"
                                className="form-input"
                                placeholder="0"
                                {...register(`participants.${index}.count` as const, {
                                  min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' },
                                  max: { value: 50, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเน€เธเธดเธ 50 เธเธ' },
                                  valueAsNumber: true,
                                  onChange: () => {
                                    // Reset selected participants if count is reduced
                                    const currentCount = Number(watch(`participants.${index}.count`)) || 0;
                                    const currentSelected = watch(`participants.${index}.selectedParticipants`) || [];
                                    if (currentSelected.length > currentCount) {
                                      setValue(`participants.${index}.selectedParticipants`, currentSelected.slice(0, currentCount));
                                    }

                                    // Trigger total recalculation
                                    setTimeout(() => {
                                      const participants = watch('participants') || [];
                                      const total = participants.reduce((sum, p) => sum + (Number(p?.count) || 0), 0);
                                      setValue('totalParticipants', total);
                                    }, 0);
                                  }
                                })}
                              />
                            </div>
                          </div>

                          {/* Participant Selector */}
                          {currentParticipant?.team && currentParticipant?.count > 0 && (
                            <ParticipantSelector
                              team={currentParticipant.team}
                              maxCount={currentParticipant.count}
                              selectedParticipants={currentParticipant.selectedParticipants || []}
                              onParticipantsChange={(participants) => {
                                setValue(`participants.${index}.selectedParticipants`, participants);
                              }}
                            />
                          )}
                        </div>
                      );
                    })}

                    <Button
                      type="button"
                      onClick={() => appendParticipant({ team: '', count: 0, selectedParticipants: [] })}
                      className="mt-2"
                      variant="outline"
                    >
                      <Plus className="mr-2 h-4 w-4" />
                      เน€เธเธดเนเธกเธ—เธตเธก
                    </Button>
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="form-label font-semibold">เธฃเธงเธกเธเธณเธเธงเธเธเธนเนเน€เธเนเธฒเธญเธเธฃเธกเธ—เธฑเนเธเธซเธกเธ”</label>
                  <div className="flex items-center gap-4">
                    <Input
                      type="number"
                      className="form-input bg-gray-100 font-bold text-lg text-center w-[151px]"
                      readOnly
                      value={watch('totalParticipants') || 0}
                      {...register('totalParticipants')}
                    />
                    <Button
                      type="button"
                      onClick={downloadTrainingCSV}
                      variant="outline"
                      className="flex items-center gap-2"
                      disabled={!watch('totalParticipants') || watch('totalParticipants') === 0}
                    >
                      <Download className="h-4 w-4" />
                      Download CSV
                    </Button>
                  </div>
                </div>
              </div>

              {/* เธชเนเธงเธเธ—เธตเน 3: เธเธเธเธฃเธฐเธกเธฒเธ“เนเธฅเธฐเธเนเธฒเนเธเนเธเนเธฒเธข */}
              <div className="space-y-6">
                <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">เธเธเธเธฃเธฐเธกเธฒเธ“เนเธฅเธฐเธเนเธฒเนเธเนเธเนเธฒเธข</h3>



                {/* เธเนเธฒเธงเธดเธ—เธขเธฒเธเธฃ */}
                <div className="border rounded-lg p-4 bg-gray-50">
                  <h4 className="font-semibold text-gray-700 mb-3">1. เธเนเธฒเธงเธดเธ—เธขเธฒเธเธฃ</h4>
                  <div className="grid grid-cols-4 gap-4">
                    <div className="space-y-2">
                      <label className="form-label text-sm">เธเธณเธเธงเธเน€เธเธดเธ</label>
                      <Input
                        type="number"
                        step="0.01"
                        min="0"
                        className="form-input"
                        placeholder="0.00"
                        {...register('instructorFee', {
                          min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                        })}
                      />
                      {errors.instructorFee && (
                        <p className="text-red-500 text-xs mt-1">{errors.instructorFee.message}</p>
                      )}
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm">เธซเธฑเธเธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธข (3%)</label>
                      <Input
                        type="number"
                        step="0.01"
                        min="0"
                        className="form-input"
                        placeholder="0.00"
                        {...register('instructorFeeWithholding', {
                          min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                        })}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm">VAT (7%)</label>
                      <Input
                        type="number"
                        step="0.01"
                        min="0"
                        className="form-input"
                        placeholder="0.00"
                        {...register('instructorFeeVat', {
                          min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                        })}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm font-semibold">เธฃเธงเธก</label>
                      <Input
                        type="number"
                        step="0.01"
                        className="form-input bg-blue-100 font-semibold"
                        readOnly
                        value={watch('instructorFeeTotal') ? Number(watch('instructorFeeTotal')).toFixed(2) : '0.00'}
                        {...register('instructorFeeTotal')}
                      />
                    </div>
                  </div>
                </div>

                {/* เธเนเธฒเธซเนเธญเธ เธญเธฒเธซเธฒเธฃเนเธฅเธฐเน€เธเธฃเธทเนเธญเธเธ”เธทเนเธก */}
                <div className="border rounded-lg p-4 bg-gray-50">
                  <h4 className="font-semibold text-gray-700 mb-3">2. เธเนเธฒเธซเนเธญเธ เธญเธฒเธซเธฒเธฃเนเธฅเธฐเน€เธเธฃเธทเนเธญเธเธ”เธทเนเธก</h4>
                  <div className="grid grid-cols-4 gap-4">
                    <div className="space-y-2">
                      <label className="form-label text-sm">เธเธณเธเธงเธเน€เธเธดเธ</label>
                      <Input
                        type="number"
                        step="0.01"
                        min="0"
                        className="form-input"
                        placeholder="0.00"
                        {...register('roomFoodBeverage', {
                          min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                        })}
                      />
                      {errors.roomFoodBeverage && (
                        <p className="text-red-500 text-xs mt-1">{errors.roomFoodBeverage.message}</p>
                      )}
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm">เธซเธฑเธเธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธข (3%)</label>
                      <Input
                        type="number"
                        step="0.01"
                        min="0"
                        className="form-input"
                        placeholder="0.00"
                        {...register('roomFoodBeverageWithholding', {
                          min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                        })}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm">VAT (7%)</label>
                      <Input
                        type="number"
                        step="0.01"
                        min="0"
                        className="form-input"
                        placeholder="0.00"
                        {...register('roomFoodBeverageVat', {
                          min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                        })}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm font-semibold">เธฃเธงเธก</label>
                      <Input
                        type="number"
                        step="0.01"
                        className="form-input bg-blue-100 font-semibold"
                        readOnly
                        value={watch('roomFoodBeverageTotal') ? Number(watch('roomFoodBeverageTotal')).toFixed(2) : '0.00'}
                        {...register('roomFoodBeverageTotal')}
                      />
                    </div>
                  </div>
                </div>

                {/* เธเนเธฒเนเธเนเธเนเธฒเธขเธญเธทเนเธเน */}
                <div className="border rounded-lg p-4 bg-gray-50">
                  <h4 className="font-semibold text-gray-700 mb-3">3. เธเนเธฒเนเธเนเธเนเธฒเธขเธญเธทเนเธเน</h4>
                  <div className="grid grid-cols-4 gap-4">
                    <div className="space-y-2">
                      <label className="form-label text-sm">เธเธณเธเธงเธเน€เธเธดเธ</label>
                      <Input
                        type="number"
                        step="0.01"
                        min="0"
                        className="form-input"
                        placeholder="0.00"
                        {...register('otherExpenses', {
                          min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                        })}
                      />
                      {errors.otherExpenses && (
                        <p className="text-red-500 text-xs mt-1">{errors.otherExpenses.message}</p>
                      )}
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm">เธซเธฑเธเธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธข (3%)</label>
                      <Input
                        type="number"
                        step="0.01"
                        min="0"
                        className="form-input"
                        placeholder="0.00"
                        {...register('otherExpensesWithholding', {
                          min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                        })}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm">VAT (7%)</label>
                      <Input
                        type="number"
                        step="0.01"
                        min="0"
                        className="form-input"
                        placeholder="0.00"
                        {...register('otherExpensesVat', {
                          min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                        })}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm font-semibold">เธฃเธงเธก</label>
                      <Input
                        type="number"
                        step="0.01"
                        className="form-input bg-blue-100 font-semibold"
                        readOnly
                        value={watch('otherExpensesTotal') ? Number(watch('otherExpensesTotal')).toFixed(2) : '0.00'}
                        {...register('otherExpensesTotal')}
                      />
                    </div>
                  </div>
                </div>

                {/* เธชเธฃเธธเธเธฃเธงเธก */}
                <div className="border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                  <h4 className="font-bold text-blue-800 mb-4">เธชเธฃเธธเธเธฃเธงเธกเธ—เธฑเนเธเธซเธกเธ”</h4>
                  <div className="grid grid-cols-4 gap-4">
                    <div className="space-y-2">
                      <label className="form-label text-sm font-semibold">เธฃเธงเธกเธซเธฑเธเธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธข</label>
                      <Input
                        type="number"
                        step="0.01"
                        className="form-input bg-red-100 font-semibold"
                        readOnly
                        value={watch('withholdingTax') ? Number(watch('withholdingTax')).toFixed(2) : '0.00'}
                        {...register('withholdingTax')}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm font-semibold">เธฃเธงเธก VAT</label>
                      <Input
                        type="number"
                        step="0.01"
                        className="form-input bg-green-100 font-semibold"
                        readOnly
                        value={watch('vat') ? Number(watch('vat')).toFixed(2) : '0.00'}
                        {...register('vat')}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm font-bold">เธฃเธงเธกเน€เธเนเธเน€เธเธดเธเธ—เธฑเนเธเธชเธดเนเธ</label>
                      <Input
                        type="number"
                        step="0.01"
                        className="form-input bg-yellow-100 font-bold text-lg"
                        readOnly
                        value={watch('totalAmount') ? Number(watch('totalAmount')).toFixed(2) : '0.00'}
                        {...register('totalAmount')}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="form-label text-sm font-semibold">เน€เธเธฅเธตเนเธขเธ•เนเธญเธเธ</label>
                      <Input
                        type="number"
                        step="0.01"
                        className="form-input bg-purple-100 font-semibold"
                        readOnly
                        value={watch('averageCostPerPerson') ? Number(watch('averageCostPerPerson')).toFixed(2) : '0.00'}
                        {...register('averageCostPerPerson')}
                      />
                    </div>
                  </div>
                </div>
              </div>

              {/* เธชเนเธงเธเธ—เธตเน 4: เธซเธกเธฒเธขเน€เธซเธ•เธธ */}
              <div className="space-y-6">
                <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">เธซเธกเธฒเธขเน€เธซเธ•เธธ</h3>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="form-label">เธญเธญเธเธซเธเธฑเธเธชเธทเธญเธฃเธฑเธเธฃเธญเธเธซเธฑเธเธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธขเนเธเธเธฒเธก</label>
                    <Input
                      placeholder="เธฃเธฐเธเธธเธเธทเนเธญเธ—เธตเนเธ•เนเธญเธเธเธฒเธฃเธญเธญเธเธซเธเธฑเธเธชเธทเธญเธฃเธฑเธเธฃเธญเธ"
                      className="form-input"
                      {...register('taxCertificateName')}
                    />
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เธเธณเธเธงเธเน€เธเธดเธเธ—เธตเนเธ•เนเธญเธเธซเธฑเธ เธ“ เธ—เธตเนเธเนเธฒเธข</label>
                    <Input
                      type="number"
                      step="0.01"
                      className="form-input bg-gray-100"
                      readOnly
                      value={watch('withholdingTaxAmount') ? Number(watch('withholdingTaxAmount')).toFixed(2) : ''}
                      {...register('withholdingTaxAmount')}
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="form-label">เธซเธกเธฒเธขเน€เธซเธ•เธธเน€เธเธดเนเธกเน€เธ•เธดเธก</label>
                  <Textarea
                    className="form-input min-h-[100px]"
                    placeholder="เธเธฃเธญเธเธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เน€เธเธดเนเธกเน€เธ•เธดเธกเธ–เนเธฒเธกเธต"
                    {...register('additionalNotes')}
                  />
                </div>
              </div>
            </>
          )}

          {/* Advance (เน€เธเธดเธเน€เธเธดเธเธ—เธ”เธฅเธญเธ) specific fields */}
          {type === 'advance' && (
            <>
              {/* เธชเนเธงเธเธ—เธตเน 1: เธเนเธญเธกเธนเธฅเธ—เธฑเนเธงเนเธ */}
              <div className="space-y-6">
                <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">เธเนเธญเธกเธนเธฅเธ—เธฑเนเธงเนเธ</h3>

                {/* เนเธเธเธเนเธฅเธฐเน€เธเธ• */}
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="form-label">เนเธเธเธ</label>
                    <Input
                      placeholder="เธฃเธฐเธเธธเนเธเธเธ"
                      className="form-input"
                      {...register('advanceDepartment', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเนเธเธเธ'
                      })}
                    />
                    {errors.advanceDepartment && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceDepartment.message}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เน€เธเธ•</label>
                    <Input
                      placeholder="เธฃเธฐเธเธธเน€เธเธ•"
                      className="form-input"
                      {...register('advanceDistrict', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเน€เธเธ•'
                      })}
                    />
                    {errors.advanceDistrict && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceDistrict.message}</p>
                    )}
                  </div>
                </div>

                {/* เธเธฃเธฐเน€เธ เธ—เธเธดเธเธเธฃเธฃเธก */}
                <div className="space-y-2">
                  <label className="form-label">เธเธฃเธฐเน€เธ เธ—เธเธดเธเธเธฃเธฃเธก</label>
                  <Select
                    onValueChange={(value) => setValue('advanceActivityType', value)}
                    defaultValue={watch('advanceActivityType')}
                  >
                    <SelectTrigger className="form-input">
                      <SelectValue placeholder="เน€เธฅเธทเธญเธเธเธฃเธฐเน€เธ เธ—เธเธดเธเธเธฃเธฃเธก" />
                    </SelectTrigger>
                    <SelectContent>
                      {ACTIVITY_TYPES.map((activity) => (
                        <SelectItem key={activity} value={activity}>{activity}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  {errors.advanceActivityType && (
                    <p className="text-red-500 text-sm mt-1">{errors.advanceActivityType.message}</p>
                  )}
                </div>

                {/* เธเธดเธฅเธ”เนเธฃเธฐเธเธธเธญเธทเนเธเน เน€เธกเธทเนเธญเน€เธฅเธทเธญเธ "เธญเธทเนเธเน เธฃเธฐเธเธธ" */}
                {watch('advanceActivityType') === 'เธญเธทเนเธเน เธฃเธฐเธเธธ' && (
                  <div className="space-y-2">
                    <label className="form-label">เนเธเธฃเธ”เธฃเธฐเธเธธ</label>
                    <Input
                      placeholder="เธฃเธฐเธเธธเธเธฃเธฐเน€เธ เธ—เธเธดเธเธเธฃเธฃเธกเธญเธทเนเธเน"
                      className="form-input"
                      {...register('advanceActivityOther', {
                        required: watch('advanceActivityType') === 'เธญเธทเนเธเน เธฃเธฐเธเธธ' ? 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธเธฃเธฐเน€เธ เธ—เธเธดเธเธเธฃเธฃเธก' : false
                      })}
                    />
                    {errors.advanceActivityOther && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceActivityOther.message}</p>
                    )}
                  </div>
                )}

                {/* เธเนเธญเธกเธนเธฅเธชเธ–เธฒเธเธ—เธตเน */}
                <div className="space-y-2">
                  <label className="form-label">เธเธทเนเธญเธฃเนเธฒเธ/เธเธฃเธดเธฉเธฑเธ—</label>
                  <Input
                    placeholder="เธฃเธฐเธเธธเธเธทเนเธญเธฃเนเธฒเธเธซเธฃเธทเธญเธเธฃเธดเธฉเธฑเธ—"
                    className="form-input"
                    {...register('advanceShopCompany', {
                      required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธเธทเนเธญเธฃเนเธฒเธ/เธเธฃเธดเธฉเธฑเธ—'
                    })}
                  />
                  {errors.advanceShopCompany && (
                    <p className="text-red-500 text-sm mt-1">{errors.advanceShopCompany.message}</p>
                  )}
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="form-label">เธญเธณเน€เธ เธญ</label>
                    <Input
                      placeholder="เธฃเธฐเธเธธเธญเธณเน€เธ เธญ"
                      className="form-input"
                      {...register('advanceAmphur', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธญเธณเน€เธ เธญ'
                      })}
                    />
                    {errors.advanceAmphur && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceAmphur.message}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เธเธฑเธเธซเธงเธฑเธ”</label>
                    <Input
                      placeholder="เธฃเธฐเธเธธเธเธฑเธเธซเธงเธฑเธ”"
                      className="form-input"
                      {...register('advanceProvince', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธเธฑเธเธซเธงเธฑเธ”'
                      })}
                    />
                    {errors.advanceProvince && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceProvince.message}</p>
                    )}
                  </div>
                </div>
              </div>

              {/* เธชเนเธงเธเธ—เธตเน 2: เธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เธเธฒเธ */}
              <div className="space-y-6">
                <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">เธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เธเธฒเธ</h3>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="form-label">เธงเธฑเธเธ—เธตเนเธเธฑเธ”</label>
                    <Input
                      type="date"
                      className="form-input"
                      {...register('advanceEventDate', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธงเธฑเธเธ—เธตเนเธเธฑเธ”'
                      })}
                    />
                    {errors.advanceEventDate && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceEventDate.message}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เธเธณเธเธงเธเธเธนเนเน€เธเนเธฒเธฃเนเธงเธก</label>
                    <Input
                      type="number"
                      min="0"
                      className="form-input"
                      placeholder="0"
                      {...register('advanceParticipants', {
                        required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธเธณเธเธงเธเธเธนเนเน€เธเนเธฒเธฃเนเธงเธก',
                        min: { value: 1, message: 'เธเธณเธเธงเธเธเธนเนเน€เธเนเธฒเธฃเนเธงเธกเธ•เนเธญเธเธกเธฒเธเธเธงเนเธฒ 0' },
                        valueAsNumber: true
                      })}
                    />
                    {errors.advanceParticipants && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceParticipants.message}</p>
                    )}
                  </div>
                </div>
              </div>

              {/* เธชเนเธงเธเธ—เธตเน 3: เธเนเธฒเนเธเนเธเนเธฒเธข */}
              <div className="space-y-6">
                <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">เธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เธเนเธฒเนเธเนเธเนเธฒเธข</h3>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="form-label">เธญเธฑเธ•เธฃเธฒเธเนเธฒเนเธเนเธเนเธฒเธขเธ•เนเธญเธเธ (เธเธฒเธ—)</label>
                    <Input
                      type="number"
                      step="0.01"
                      min="0"
                      className="form-input"
                      placeholder="0.00"
                      {...register('advanceDailyRate', {
                        min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                      })}
                    />
                    {errors.advanceDailyRate && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceDailyRate.message}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เธเนเธฒเธ—เธตเนเธเธฑเธ (เธเธฒเธ—)</label>
                    <Input
                      type="number"
                      step="0.01"
                      min="0"
                      className="form-input"
                      placeholder="0.00"
                      {...register('advanceAccommodationCost', {
                        min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                      })}
                    />
                    {errors.advanceAccommodationCost && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceAccommodationCost.message}</p>
                    )}
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="form-label">เธเนเธฒเน€เธ”เธดเธเธ—เธฒเธ (เธเธฒเธ—)</label>
                    <Input
                      type="number"
                      step="0.01"
                      min="0"
                      className="form-input"
                      placeholder="0.00"
                      {...register('advanceTransportationCost', {
                        min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                      })}
                    />
                    {errors.advanceTransportationCost && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceTransportationCost.message}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="form-label">เน€เธเธตเนเธขเน€เธฅเธตเนเธขเธ (เธเธฒเธ—)</label>
                    <Input
                      type="number"
                      step="0.01"
                      min="0"
                      className="form-input"
                      placeholder="0.00"
                      {...register('advanceMealAllowance', {
                        min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                      })}
                    />
                    {errors.advanceMealAllowance && (
                      <p className="text-red-500 text-sm mt-1">{errors.advanceMealAllowance.message}</p>
                    )}
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="form-label">เธเนเธฒเนเธเนเธเนเธฒเธขเธญเธทเนเธเน (เธเธฒเธ—)</label>
                  <Input
                    type="number"
                    step="0.01"
                    min="0"
                    className="form-input"
                    placeholder="0.00"
                    {...register('advanceOtherExpenses', {
                      min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' }
                    })}
                  />
                  {errors.advanceOtherExpenses && (
                    <p className="text-red-500 text-sm mt-1">{errors.advanceOtherExpenses.message}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <label className="form-label font-semibold">เธฃเธงเธกเธเธณเธเธงเธเน€เธเธดเธเธ—เธตเนเธเธญเน€เธเธดเธเธ—เธ”เธฅเธญเธ (เธเธฒเธ—)</label>
                  <Input
                    type="number"
                    step="0.01"
                    className="form-input bg-blue-50 font-bold text-lg"
                    readOnly
                    value={watch('amount') ? Number(watch('amount')).toFixed(2) : ''}
                    {...register('amount')}
                  />
                </div>
              </div>
            </>
          )}

          {/* Continue with existing fields for other welfare types */}
          {type !== 'training' && type !== 'internal_training' && type !== 'advance' && (
            <>
              {/* Original amount field */}
              <div className="space-y-2">
                <label htmlFor="amount" className="form-label">เธเธณเธเธงเธเน€เธเธดเธ (เธเธฒเธ—)</label>
                <Input
                  id="amount"
                  type="number"
                  step="0.01"
                  className="form-input"
                  placeholder="เธฃเธฐเธเธธเธเธณเธเธงเธเน€เธเธดเธ"
                  {...register('amount', {
                    required: 'เธเธฃเธธเธ“เธฒเธฃเธฐเธเธธเธเธณเธเธงเธเน€เธเธดเธ',
                    min: {
                      value: 1,
                      message: 'เธเธณเธเธงเธเน€เธเธดเธเธ•เนเธญเธเธกเธฒเธเธเธงเนเธฒ 0'
                    },
                    max: {
                      value: maxAmount || 100000,
                      message: `เธเธณเธเธงเธเน€เธเธดเธเธ•เนเธญเธเนเธกเนเน€เธเธดเธ ${maxAmount} เธเธฒเธ—`
                    },
                    validate: {
                      notMoreThanRemaining: value =>
                        Number(value) <= remainingBudget || 'เธเธณเธเธงเธเน€เธเธดเธเน€เธเธดเธเธเธเธเธฃเธฐเธกเธฒเธ“เธ—เธตเนเน€เธซเธฅเธทเธญเธญเธขเธนเน'
                    },
                    onChange: (e) => {
                      const amount = Number(e.target.value);
                      const vatAmount = Number(watch('tax7Percent')) || 0;
                      const withholdingAmount = Number(watch('withholdingTax3Percent')) || 0;
                      calculateNonTrainingAmounts(amount, vatAmount, withholdingAmount);
                    }
                  })}
                />
                {errors.amount && (
                  <p className="text-red-500 text-sm mt-1">{errors.amount.message}</p>
                )}
              </div>



              {/* VAT and Tax fields for non-training types */}
              <div className="grid grid-cols-3 gap-4">
                <div className="space-y-2">
                  <label className="form-label">เธ เธฒเธฉเธตเธกเธนเธฅเธเนเธฒเน€เธเธดเนเธก (7%)</label>
                  <Input
                    type="number"
                    className="form-input"
                    step="0.01"
                    min="0"
                    placeholder="0.00"
                    defaultValue="0"
                    {...register('tax7Percent', {
                      min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' },
                      onChange: (e) => {
                        const amount = watch('amount');
                        const vatAmount = Number(e.target.value) || 0;
                        const withholdingAmount = Number(watch('withholdingTax3Percent')) || 0;
                        if (amount) {
                          calculateNonTrainingAmounts(Number(amount), vatAmount, withholdingAmount);
                        }
                      }
                    })}
                  />
                  {errors.tax7Percent && (
                    <p className="text-red-500 text-sm mt-1">{errors.tax7Percent.message}</p>
                  )}
                </div>
                <div className="space-y-2">
                  <label className="form-label">เธซเธฑเธเธ เธฒเธฉเธต เธ“ เธ—เธตเนเธเนเธฒเธข (3%)</label>
                  <Input
                    type="number"
                    className="form-input"
                    step="0.01"
                    min="0"
                    placeholder="0.00"
                    defaultValue="0"
                    {...register('withholdingTax3Percent', {
                      min: { value: 0, message: 'เธเธณเธเธงเธเธ•เนเธญเธเนเธกเนเธเนเธญเธขเธเธงเนเธฒ 0' },
                      onChange: (e) => {
                        const amount = watch('amount');
                        const withholdingAmount = Number(e.target.value) || 0;
                        const vatAmount = Number(watch('tax7Percent')) || 0;
                        if (amount) {
                          calculateNonTrainingAmounts(Number(amount), vatAmount, withholdingAmount);
                        }
                      }
                    })}
                  />
                  {errors.withholdingTax3Percent && (
                    <p className="text-red-500 text-sm mt-1">{errors.withholdingTax3Percent.message}</p>
                  )}
                </div>
                <div className="space-y-2">
                  <label className="form-label">เธเธณเธเธงเธเน€เธเธดเธเธชเธธเธ—เธเธด</label>
                  <Input
                    type="number"
                    step="0.01"
                    className="form-input bg-gray-100"
                    readOnly
                    value={watch('netAmount') ? Number(watch('netAmount')).toFixed(2) : ''}
                    {...register('netAmount')}
                  />
                </div>
              </div>
            </>
          )}

          {/* Details Field */}
          <div className="space-y-2">
            <label htmlFor="details" className="form-label">เธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”</label>
            <Textarea
              id="details"
              className="form-input min-h-[100px]"
              placeholder="เธเธฃเธญเธเธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เน€เธเธดเนเธกเน€เธ•เธดเธกเธ–เนเธฒเธกเธต"
              {...register('details', {

                minLength: {
                  value: 0,
                  message: 'เธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เธ•เนเธญเธเธกเธตเธเธงเธฒเธกเธขเธฒเธงเธญเธขเนเธฒเธเธเนเธญเธข 0 เธ•เธฑเธงเธญเธฑเธเธฉเธฃ'
                }
              })}
            />
            {errors.details && (
              <p className="text-red-500 text-sm mt-1">{errors.details.message}</p>
            )}
          </div>

          {/* Attachment checklist (placed above file upload) */}
          {type !== 'training' && type !== 'internal_training' && type !== 'advance' && (
            <div className="space-y-3">
              <h3 className="text-md font-semibold text-gray-800">เน€เธฅเธทเธญเธเน€เธญเธเธชเธฒเธฃเธเธฃเธฐเธเธญเธเธเธฒเธฃเน€เธเธดเธ</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" {...register('attachmentSelections.receipt')} />
                  <span>เนเธเน€เธชเธฃเนเธเธฃเธฑเธเน€เธเธดเธ</span>
                </label>
                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" {...register('attachmentSelections.idCardCopy')} />
                  <span>เธชเธณเน€เธเธฒเธเธฑเธ•เธฃเธเธฃเธฐเธเธฒเธเธ</span>
                </label>
                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" {...register('attachmentSelections.bankBookCopy')} />
                  <span>เธชเธณเน€เธเธฒเธเธฑเธเธเธตเธเธเธฒเธเธฒเธฃ</span>
                </label>

                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" {...register('attachmentSelections.birthCertificate')} />
                  <span>เธชเธณเน€เธเธฒเธชเธนเธ•เธดเธเธฑเธ•เธฃเธเธธเธ•เธฃ</span>
                </label>
                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" {...register('attachmentSelections.deathCertificate')} />
                  <span>เธชเธณเน€เธเธฒเนเธเธกเธฃเธ“เธฐเธเธฑเธ•เธฃ</span>
                </label>
                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" {...register('attachmentSelections.weddingCard')} />
                  <span>เธเธฒเธฃเนเธ”เนเธ•เนเธเธเธฒเธ</span>
                </label>

                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" {...register('attachmentSelections.medicalCertificate')} />
                  <span>เนเธเธฃเธฑเธเธฃเธญเธเนเธเธ—เธขเน</span>
                </label>
                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" {...register('attachmentSelections.marriageCertificate')} />
                  <span>เธชเธณเน€เธเธฒเธ—เธฐเน€เธเธตเธขเธเธชเธกเธฃเธช</span>
                </label>
                <div className="flex items-center gap-2 text-sm">
                  <label className="flex items-center gap-2">
                    <input type="checkbox" {...register('attachmentSelections.other')} />
                    <span>เธญเธทเนเธเน</span>
                  </label>
                  <Input
                    placeholder="เธฃเธฐเธเธธ..."
                    className="h-8"
                    {...register('attachmentSelections.otherText')}
                  />
                </div>
              </div>
            </div>
          )}

          {/* File Upload */}
          <div className="space-y-2">
            <label htmlFor="attachments" className="form-label flex items-center gap-2">
              <Paperclip className="h-4 w-4" />
              เนเธเธเน€เธญเธเธชเธฒเธฃ (เนเธเน€เธชเธฃเนเธเธฃเธฑเธเน€เธเธดเธ, เธฃเธฒเธขเธฅเธฐเน€เธญเธตเธขเธ”เธซเธฅเธฑเธเธชเธนเธ•เธฃ, เนเธเน€เธชเธเธญเธฃเธฒเธเธฒ/เนเธเนเธเนเธเธซเธเธตเน)
            </label>
            <div className="flex items-center gap-2">
              <Input
                id="attachments"
                type="file"
                className="form-input"
                onChange={handleFileChange}
                multiple
              />
            </div>

            {/* Show uploaded files */}
            {files.length > 0 && (
              <div className="mt-2">
                <p className="text-sm font-medium mb-1">เนเธเธฅเนเธ—เธตเนเธญเธฑเธเนเธซเธฅเธ”:</p>
                <ul className="text-sm space-y-1">
                  {files.map((file, index) => {
                    const fileName = file.split('/').pop() || `เนเธเธฅเน ${index + 1}`;
                    return (
                      <li key={index} className="flex items-center justify-between group">
                        <div className="flex items-center gap-2 text-green-600">
                          <Check className="h-4 w-4 flex-shrink-0" />
                          <a
                            href={file}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="truncate hover:underline"
                            title={fileName}
                          >
                            {fileName}
                          </a>
                        </div>
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          className="h-6 w-6 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                          onClick={() => handleRemoveFile(index)}
                        >
                          <X className="h-3.5 w-3.5" />
                          <span className="sr-only">เธฅเธเนเธเธฅเน</span>
                        </Button>
                      </li>
                    );
                  })}
                </ul>
                <p className="text-xs text-gray-500 mt-1">
                  เธเธณเธเธงเธเนเธเธฅเนเธ—เธตเนเธญเธฑเธเนเธซเธฅเธ”: {files.length} เนเธเธฅเน
                </p>
              </div>
            )}
          </div>

          {/* Submit Button */}
          <Button
            type="submit"
            className="w-full btn-hover-effect"
            disabled={isLoading || isSubmitting || (type === 'training' && Boolean(workDaysError))}
          >
            {isLoading ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                เธเธณเธฅเธฑเธเธชเนเธเธเธณเธฃเนเธญเธ...
              </>
            ) : (
              'เธชเนเธเธเธณเธฃเนเธญเธ'
            )}
          </Button>

          {/* Animated Loading Popup */}
          <LoadingPopup open={isSubmitting} />
        </form>
      </div>

      {/* Digital Signature Modal */}
      <DigitalSignature
        isOpen={showSignatureModal}
        onClose={() => {
          setShowSignatureModal(false);
          setPendingFormData(null);
        }}
        onConfirm={handleSignatureConfirm}
        userName={user?.email || ''}
      />
    </div>
  );
}

