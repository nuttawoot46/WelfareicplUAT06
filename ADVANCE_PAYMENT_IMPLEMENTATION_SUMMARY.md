# สรุปการพัฒนาระบบเบิกเงินล่วงหน้า (Advance Payment System)

## ภาพรวมการพัฒนา
ได้พัฒนาระบบเบิกเงินล่วงหน้าที่สมบูรณ์ตามรูปแบบ PDF ที่ให้มา โดยมี Flow การอนุมัติเป็น: **User > Manager > Accounting** (ไม่ผ่าน HR ตามที่ร้องขอ)

## ไฟล์ที่สร้างใหม่

### 1. PDF Generator
- **`src/components/pdf/AdvancePDFGenerator.tsx`**
  - สร้าง PDF ตามรูปแบบที่ให้มาเป๊ะๆ
  - รองรับการแสดงข้อมูลทั้งหมดตาม PDF ต้นฉบับ
  - มีตารางรายละเอียดค่าใช้จ่ายครบถ้วน
  - รองรับลายเซ็นดิจิทัล

### 2. PDF Manager
- **`src/utils/advancePdfManager.ts`**
  - จัดการการสร้างและอัปโหลด PDF
  - รองรับการอัปเดต PDF เมื่อมีลายเซ็นใหม่
  - ฟังก์ชันดาวน์โหลด PDF

### 3. หน้าเบิกเงินล่วงหน้า
- **`src/pages/AdvancePaymentPage.tsx`**
  - ฟอร์มครบถ้วนตามข้อมูลใน PDF
  - รองรับการคำนวณค่าใช้จ่ายอัตโนมัติ
  - ระบบลายเซ็นดิจิทัล
  - การตรวจสอบข้อมูลก่อนส่ง

### 4. Database Migration
- **`supabase/migrations/20241223000000_add_advance_payment_fields.sql`**
  - เพิ่มฟิลด์สำหรับเบิกเงินล่วงหน้า
  - เพิ่มฟิลด์สำหรับการอนุมัติของ Accounting
  - อัปเดต enum สำหรับสถานะใหม่

## ไฟล์ที่อัปเดต

### 1. Navigation & Routing
- **`src/components/layout/Sidebar.tsx`** - เพิ่มลิงก์เบิกเงินล่วงหน้า
- **`src/App.tsx`** - เพิ่ม route สำหรับหน้าเบิกเงินล่วงหน้า

### 2. Form Components
- **`src/components/forms/WelfareFormSelector.tsx`** - เพิ่มตัวเลือกเบิกเงินล่วงหน้า
- **`src/components/forms/WelfareForm.tsx`** - เปลี่ยนเส้นทางไปหน้าเฉพาะ

### 3. API Services
- **`src/services/welfareApi.ts`** - เพิ่มฟังก์ชันสำหรับ advance payment

## คุณสมบัติหลัก

### 1. ฟอร์มเบิกเงินล่วงหน้า
- **ข้อมูลพื้นฐาน**: แผนก, เขต, ประเภทกิจกรรม
- **รายละเอียดกิจกรรม**: กิจกรรม, วันที่, สถานที่, จำนวนผู้เข้าร่วม
- **ค่าใช้จ่าย**: อัตราต่อวัน, จำนวนวัน, ค่าที่พัก, ค่าเดินทาง, ค่าอาหาร, ค่าใช้จ่ายอื่นๆ
- **การคำนวณอัตโนมัติ**: รวมจำนวนเงินทั้งหมด

### 2. PDF Generator
- **รูปแบบเป๊ะๆ**: ตามรูปแบบ PDF ที่ให้มา
- **ข้อมูลครบถ้วน**: แสดงข้อมูลทุกฟิลด์ที่กรอก
- **ตารางค่าใช้จ่าย**: แสดงรายละเอียดตามตัวอย่าง
- **ลายเซ็น 2 ช่อง**: ผู้ขอเบิก + ผู้อนุมัติ (Manager) เท่านั้น
- **หมายเหตุสำหรับบัญชี**: เพิ่มส่วนแจ้งฝ่ายบัญชี

### 3. Flow การอนุมัติ (ปรับปรุงแล้ว)
```
User (ลงลายเซ็น) → Manager (ลงลายเซ็น) → ส่งต่อ Accounting → เสร็จสิ้น
```

### 4. สถานะการอนุมัติ
- `pending_manager` - รอผู้จัดการอนุมัติ
- `pending_accounting` - ส่งต่อให้ฝ่ายบัญชีแล้ว (สำหรับ advance เท่านั้น)
- `pending_hr` - ส่งต่อให้ HR (สำหรับประเภทอื่น)
- `completed` - อนุมัติเสร็จสิ้น
- `rejected_manager` - ผู้จัดการปฏิเสธ
- `rejected_accounting` - ฝ่ายบัญชีปฏิเสธ

## ฟิลด์ในฐานข้อมูล

### Advance Payment Fields
- `advance_department` - แผนก
- `advance_district` - เขต
- `advance_activity_type` - ประเภทกิจกรรม
- `advance_activity_other` - กิจกรรมอื่นๆ
- `advance_daily_rate` - อัตราค่าใช้จ่ายต่อวัน
- `advance_total_days` - จำนวนวันทั้งหมด
- `advance_accommodation_cost` - ค่าที่พัก
- `advance_transportation_cost` - ค่าเดินทาง
- `advance_meal_allowance` - ค่าอาหาร
- `advance_other_expenses` - ค่าใช้จ่ายอื่นๆ

### Accounting Approval Fields
- `accounting_approver_id` - ID ผู้อนุมัติฝ่ายบัญชี
- `accounting_approver_name` - ชื่อผู้อนุมัติฝ่ายบัญชี
- `accounting_approved_at` - วันที่อนุมัติ
- `accounting_notes` - หมายเหตุจากฝ่ายบัญชี

## การใช้งาน

### สำหรับผู้ใช้ทั่วไป
1. เข้าเมนู "เบิกเงินล่วงหน้า" ใน Sidebar
2. กรอกข้อมูลในฟอร์ม
3. ระบบจะคำนวณยอดรวมอัตโนมัติ
4. ลงลายเซ็นดิจิทัล
5. ส่งคำขอ

### สำหรับผู้จัดการ
1. เข้าหน้า "อนุมัติคำร้อง (ผู้จัดการ)"
2. ดู PDF และรายละเอียด
3. อนุมัติหรือปฏิเสธ
4. ระบบจะส่งต่อไปฝ่ายบัญชี (ถ้าอนุมัติ)

### สำหรับฝ่ายบัญชี
1. เข้าหน้า "รายการรอตรวจสอบ (บัญชี)"
2. ดูรายการที่ผ่านการอนุมัติจากผู้จัดการแล้ว
3. อนุมัติขั้นสุดท้าย

## การทดสอบ
1. ทดสอบการสร้างคำขอเบิกเงินล่วงหน้า
2. ทดสอบการสร้าง PDF
3. ทดสอบ Flow การอนุมัติ
4. ทดสอบการแสดงผลในหน้าต่างๆ

## หมายเหตุ
- ระบบนี้ไม่ผ่าน HR ตามที่ร้องขอ
- PDF จะถูกสร้างตามรูปแบบเดิมเป๊ะๆ
- รองรับลายเซ็นดิจิทัลครบถ้วน
- มีการตรวจสอบข้อมูลก่อนส่ง
- รองรับการคำนวณค่าใช้จ่ายอัตโนมัติ
## 
การปรับปรุงล่าสุด

### 1. PDF Generator
- ✅ ปรับให้มีแค่ 2 ช่องลายเซ็น (User + Manager)
- ✅ เพิ่มหมายเหตุสำหรับฝ่ายบัญชี
- ✅ แสดงวันที่ลงลายเซ็นของแต่ละฝ่าย

### 2. Flow การอนุมัติ
- ✅ Manager อนุมัติแล้วส่งต่อไป `pending_accounting` (สำหรับ advance)
- ✅ ประเภทอื่นยังคงส่งไป `pending_hr` ตามเดิม
- ✅ ข้อความแจ้งเตือนปรับตามประเภท request

### 3. การแสดงผล
- ✅ AccountingReviewPage แสดง advance payment ที่มีสถานะ `pending_accounting`
- ✅ ApprovalPage แสดงสถานะที่ถูกต้องตามประเภท

### 4. Database
- ✅ เพิ่มฟิลด์สำหรับ advance payment
- ✅ เพิ่มฟิลด์สำหรับการอนุมัติของ accounting
- ✅ ปรับ constraint ให้รองรับ 'advance' type

## สรุปการทำงาน

1. **User** กรอกฟอร์มเบิกเงินล่วงหน้าและลงลายเซ็น
2. **Manager** เห็นคำขอใน ApprovalPage และลงลายเซ็นอนุมัติ
3. ระบบส่งต่อไป **Accounting** (สถานะ: `pending_accounting`)
4. **Accounting** เห็นคำขอใน AccountingReviewPage พร้อม PDF ที่มีลายเซ็นครบ
5. Accounting ดำเนินการจ่ายเงินตามรายละเอียด

## ข้อดี
- ✅ Flow สั้นและรวดเร็ว (ไม่ผ่าน HR)
- ✅ PDF มีลายเซ็นครบก่อนถึง Accounting
- ✅ ข้อมูลครบถ้วนตามรูปแบบเดิม
- ✅ ใช้ระบบเดิมที่มีอยู่ (ไม่ต้องสร้างใหม่)
- ✅ รองรับทั้ง single และ bulk approval