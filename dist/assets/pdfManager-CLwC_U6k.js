const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CRE_jXCn.js","assets/index-CBLh0gmb.css"])))=>i.map(i=>d[i]);
import{s as g,_ as j,H as M}from"./index-CRE_jXCn.js";const V=async(a,r,t,n)=>{var l,s,u,c,d,p,i,F,y,E,q;try{console.log(`üîÑ Starting addSignatureToPDF for ${r} signature, request:`,a),console.log("üìù Signature length:",(t==null?void 0:t.length)||0),console.log("üë§ Approver name:",n);const{data:_,error:h}=await g.from("welfare_requests").select("*").eq("id",a).single();if(h||!_)return console.error("‚ùå Error fetching request data:",h),!1;console.log("‚úÖ Request data fetched successfully:",{id:_.id,employee_id:_.employee_id,request_type:_.request_type,status:_.status});const A={};r==="manager"?A.manager_signature=t:r==="hr"&&(A.hr_signature=t);const{error:B}=await g.from("welfare_requests").update(A).eq("id",a);if(B)return console.error("‚ùå Error updating signature:",B),!1;console.log(`‚úÖ ${r} signature updated in database successfully`);const{data:e,error:C}=await g.from("welfare_requests").select("*").eq("id",a).single();if(C||!e)return console.error("Error fetching updated request data:",C),!1;console.log("üîç Getting employee data with:",((l=e.employee_id)==null?void 0:l.toString())||e.userId);const o=await z(((s=e.employee_id)==null?void 0:s.toString())||e.userId);if(console.log("üîç Retrieved employeeData:",o),o){const f=await b((u=e.employee_id)==null?void 0:u.toString());f&&f!==o.Name&&(console.log("üîß Correcting employee name from",o.Name,"to",f),o.Name=f)}const L=await b((c=e.employee_id)==null?void 0:c.toString());console.log("üîç User object - Actual employee name:",L);const O={id:((d=e.employee_id)==null?void 0:d.toString())||e.userId||"",email:(o==null?void 0:o.Name)||"",name:L||(o==null?void 0:o.Name)||e.employee_name||"",position:(o==null?void 0:o.Position)||"",role:"employee",department:(o==null?void 0:o.Team)||e.department_user||"",budget_fitness:0},T=await b((p=e.employee_id)==null?void 0:p.toString());console.log("üîç PDF Generation - Actual employee name:",T),console.log("üîç PDF Generation - Employee data name:",o==null?void 0:o.Name),console.log("üîç PDF Generation - Request employee name:",e.employee_name);const x={id:e.id,userId:((i=e.employee_id)==null?void 0:i.toString())||e.userId||"",userName:T||(o==null?void 0:o.Name)||e.employee_name||"",userDepartment:(o==null?void 0:o.Team)||e.department_user||"",type:e.request_type,status:e.status,amount:e.amount||0,date:e.created_at,details:e.details||"",attachments:e.attachment_url?JSON.parse(e.attachment_url):[],createdAt:e.created_at,updatedAt:e.updated_at,title:e.title,userSignature:e.user_signature,managerSignature:e.manager_signature,hrSignature:e.hr_signature,managerApproverName:e.manager_approver_name,managerApprovedAt:e.manager_approved_at,hrApproverName:e.hr_approver_name,hrApprovedAt:e.hr_approved_at,birth_type:e.birth_type,department_user:e.department_user};console.log("üîÑ Generating PDF with signatures..."),console.log("üìã PDF Data Summary:"),console.log("  - welfareRequestForPDF.userName:",x.userName),console.log("  - userForPDF.name:",O.name),console.log("  - employeeData?.Name:",o==null?void 0:o.Name);const N=await Z(x,O,o,e.user_signature,e.manager_signature,e.hr_signature);if(console.log("üìÑ PDF generated, base64 length:",(N==null?void 0:N.length)||0),N){const f={},v=atob(N),I=new Array(v.length);for(let m=0;m<v.length;m++)I[m]=v.charCodeAt(m);const H=new Uint8Array(I),W=new Blob([H],{type:"application/pdf"});if(r==="manager")try{const m=await b((F=e.employee_id)==null?void 0:F.toString());console.log("üîç Actual employee name from DB:",m);const P=m||(o==null?void 0:o.Name)||e.employee_name||"user";console.log("üîç Final employee name for filename:",P);const S=P.replace(/\s+/g,"_").replace(/[^\x00-\x7F]/g,"").replace(/[^a-zA-Z0-9_]/g,"").substring(0,50)||"employee",R=Date.now(),D=`welfare_${e.request_type}_${S}_manager_approved_${R}.pdf`;console.log("üîç Generated filename:",D);const{uploadPDFToManagerBucket:$}=await j(async()=>{const{uploadPDFToManagerBucket:k}=await import("./index-CRE_jXCn.js").then(U=>U.K);return{uploadPDFToManagerBucket:k}},__vite__mapDeps([0,1])),w=await $(W,D,(y=e.employee_id)==null?void 0:y.toString());if(w)f.pdf_request_manager=w,console.log("PDF uploaded to welfare-pdfs-manager bucket successfully (Manager):",w);else return console.error("Failed to upload PDF to welfare-pdfs-manager bucket (Manager)"),!1}catch(m){return console.error("Error uploading PDF to storage (Manager):",m),!1}else if(r==="hr")try{const m=await b((E=e.employee_id)==null?void 0:E.toString());console.log("üîç Actual employee name from DB:",m);const P=m||(o==null?void 0:o.Name)||e.employee_name||"user";console.log("üîç Final employee name for filename:",P);const S=P.replace(/\s+/g,"_").replace(/[^\x00-\x7F]/g,"").replace(/[^a-zA-Z0-9_]/g,"").substring(0,50)||"employee",R=Date.now(),D=`welfare_${e.request_type}_${S}_hr_approved_${R}.pdf`;console.log("üîç Generated filename:",D);const{uploadPDFToHRBucket:$}=await j(async()=>{const{uploadPDFToHRBucket:k}=await import("./index-CRE_jXCn.js").then(U=>U.K);return{uploadPDFToHRBucket:k}},__vite__mapDeps([0,1])),w=await $(W,D,(q=e.employee_id)==null?void 0:q.toString());if(w)f.pdf_request_hr=w,console.log("PDF uploaded to welfare-pdfs-hr bucket successfully (HR):",w);else return console.error("Failed to upload PDF to welfare-pdfs-hr bucket (HR)"),!1}catch(m){return console.error("Error uploading PDF to storage (HR):",m),!1}const{error:G}=await g.from("welfare_requests").update(f).eq("id",a);return G?(console.error("Error updating PDF:",G),!1):(console.log(`üéâ ${r} signature added to PDF successfully in column: ${r==="manager"?"pdf_request_manager":"pdf_request_hr"}`),console.log("üìä Final update data:",Object.keys(f)),!0)}return!1}catch(_){return console.error(`Error adding ${r} signature to PDF:`,_),!1}},b=async a=>{if(!a)return console.log("üîç getActualEmployeeName: No employeeId provided"),null;try{console.log("üîç getActualEmployeeName called with employeeId:",a);const r=parseInt(a,10);if(!isNaN(r)){console.log("üîç Searching employee by numeric ID:",r);const{data:l,error:s}=await g.from("Employee").select("Name").eq("id",r).single();if(console.log("üîç Employee by ID result:",{data:l,error:s}),!s&&l)return console.log("‚úÖ Found employee name by ID:",l.Name),l.Name}console.log("üîç Fallback: Searching employee by email_user:",a);const{data:t,error:n}=await g.from("Employee").select("Name").eq('"email_user"',a).single();return console.log("üîç Employee by email result:",{data:t,error:n}),n||!t?(console.log("‚ùå No employee name found for employeeId:",a),null):(console.log("‚úÖ Found employee name by email:",t.Name),t.Name)}catch(r){return console.error("‚ùå Error fetching employee name:",r),null}},z=async a=>{try{console.log("üîç getEmployeeData called with userId:",a);const r=parseInt(a,10);if(!isNaN(r)){console.log("üîç Searching by numeric ID:",r);const{data:l,error:s}=await g.from("Employee").select("Name, Position, Team").eq("id",r).single();if(console.log("üîç Employee by ID result:",{data:l,error:s}),!s&&l)return console.log("‚úÖ Found employee by ID:",l.Name),{Name:l.Name,Position:l.Position,Team:l.Team}}console.log("üîç Fallback: Searching by email_user:",a);const{data:t,error:n}=await g.from("Employee").select("Name, Position, Team").eq('"email_user"',a).single();if(console.log("üîç Employee by email result:",{data:t,error:n}),n||!t){console.log("‚ùå No employee data found for userId:",a);return}return console.log("‚úÖ Found employee by email:",t.Name),{Name:t.Name,Position:t.Position,Team:t.Team}}catch(r){console.error("‚ùå Error fetching employee data:",r);return}},Z=async(a,r,t,n,l,s)=>{try{const u=await M(a,r,t,n,l,s);return new Promise((c,d)=>{const p=new FileReader;p.onload=()=>{const i=p.result.split(",")[1];c(i)},p.onerror=d,p.readAsDataURL(u)})}catch(u){return console.error("Error generating PDF as base64:",u),null}},J=async a=>{var r,t;try{const{data:n,error:l}=await g.from("welfare_requests").select("pdf_request_manager, pdf_request_hr, employee_name, employee_id, request_type, status").eq("id",a).single();if(l||!n){console.error("Error fetching PDF or PDF not found:",l);return}const s=n.pdf_request_hr||n.pdf_request_manager,u=n.pdf_request_hr?"hr_approved":"manager_approved";if(!s){console.error("No PDF found for request:",a),alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF");return}if(s.startsWith("http")){const c=document.createElement("a");c.href=s;const i=(await b((r=n.employee_id)==null?void 0:r.toString())||n.employee_name||"user").replace(/\s+/g,"_").replace(/[^\x00-\x7F]/g,"").replace(/[^a-zA-Z0-9_]/g,"").substring(0,50)||"employee";c.download=`welfare_request_${i}_${n.request_type}_${u}_${a}.pdf`,document.body.appendChild(c),c.click(),document.body.removeChild(c)}else{const c=atob(s),d=new Array(c.length);for(let h=0;h<c.length;h++)d[h]=c.charCodeAt(h);const p=new Uint8Array(d),i=new Blob([p],{type:"application/pdf"}),F=URL.createObjectURL(i),y=document.createElement("a");y.href=F;const _=(await b((t=n.employee_id)==null?void 0:t.toString())||n.employee_name||"user").replace(/\s+/g,"_").replace(/[^\x00-\x7F]/g,"").replace(/[^a-zA-Z0-9_]/g,"").substring(0,50)||"employee";y.download=`welfare_request_${_}_${n.request_type}_${u}_${a}.pdf`,document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(F)}}catch(n){console.error("Error downloading PDF:",n)}},Q=async a=>{try{const{data:r,error:t}=await g.from("welfare_requests").select("pdf_request_manager, pdf_request_hr, status, employee_name").eq("id",a).single();if(t||!r){console.error("Error fetching PDF columns:",t);return}console.log(`PDF Columns Debug for Request ${a} (${r.employee_name}):`,{status:r.status,pdf_request_manager:r.pdf_request_manager?`${r.pdf_request_manager.length} chars`:"null",pdf_request_hr:r.pdf_request_hr?`${r.pdf_request_hr.length} chars`:"null"})}catch(r){console.error("Error in debugPDFColumns:",r)}},X=async a=>{try{const{data:r,error:t}=await g.from("welfare_requests").select("pdf_request_manager, manager_signature, hr_signature").eq("id",a).single();if(console.log("Fetched data for preview:",r),t||!r){console.error("Error fetching PDF data or request not found:",t),alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î");return}if(!r.manager_signature&&!r.hr_signature){alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö");return}const n=r.pdf_request_manager;if(n)if(n.startsWith("http"))console.log("Opening PDF from Storage URL:",n),window.open(n,"_blank")||alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Pop-up Blocker ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå");else{console.log("Opening PDF from base64 data");const l=atob(n),s=new Array(l.length);for(let i=0;i<l.length;i++)s[i]=l.charCodeAt(i);const u=new Uint8Array(s),c=new Blob([u],{type:"application/pdf"}),d=URL.createObjectURL(c);window.open(d,"_blank")||alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Pop-up Blocker ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå"),setTimeout(()=>URL.revokeObjectURL(d),1e3)}else console.error("No PDF data found for request:",a),alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PDF ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ")}catch(r){console.error("Error previewing PDF:",r),alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á PDF")}};export{V as addSignatureToPDF,Q as debugPDFColumns,J as downloadPDFFromDatabase,X as previewPDFFromDatabase};
